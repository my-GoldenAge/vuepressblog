<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发容器之ConcurrentLinkedQueue | MyGoldenAge</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/img/favicon.ico">
    <link rel="stylesheet" href="/vuepress/css/style.css">
    <script charset="utf-8" src="/vuepress/js/custom.js"></script>
    <meta name="description" content="并发容器之ConcurrentLinkedQueue">
    <meta name="keywords" content="全栈,黄金时代">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="author" content="萧瑟">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.6b8489ed.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.1688b474.js" as="script"><link rel="preload" href="/vuepress/assets/js/4.87cca1e2.js" as="script"><link rel="preload" href="/vuepress/assets/js/1.e3a634da.js" as="script"><link rel="preload" href="/vuepress/assets/js/10.33f4d679.js" as="script"><link rel="preload" href="/vuepress/assets/js/23.18ff150a.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/11.633d59fc.js"><link rel="prefetch" href="/vuepress/assets/js/12.6566debe.js"><link rel="prefetch" href="/vuepress/assets/js/13.813b91b9.js"><link rel="prefetch" href="/vuepress/assets/js/14.0508579e.js"><link rel="prefetch" href="/vuepress/assets/js/15.bea71415.js"><link rel="prefetch" href="/vuepress/assets/js/16.d5a87820.js"><link rel="prefetch" href="/vuepress/assets/js/17.a3ea973d.js"><link rel="prefetch" href="/vuepress/assets/js/18.cdcd3e86.js"><link rel="prefetch" href="/vuepress/assets/js/19.f57142c1.js"><link rel="prefetch" href="/vuepress/assets/js/20.9ff399c5.js"><link rel="prefetch" href="/vuepress/assets/js/21.bab6863c.js"><link rel="prefetch" href="/vuepress/assets/js/22.551758a7.js"><link rel="prefetch" href="/vuepress/assets/js/24.97cc5fe7.js"><link rel="prefetch" href="/vuepress/assets/js/25.ef5f5151.js"><link rel="prefetch" href="/vuepress/assets/js/26.d8424825.js"><link rel="prefetch" href="/vuepress/assets/js/27.fe42ac28.js"><link rel="prefetch" href="/vuepress/assets/js/28.306a195b.js"><link rel="prefetch" href="/vuepress/assets/js/29.15b3a25f.js"><link rel="prefetch" href="/vuepress/assets/js/30.f58e0ff8.js"><link rel="prefetch" href="/vuepress/assets/js/31.189d9dfa.js"><link rel="prefetch" href="/vuepress/assets/js/32.904cde6d.js"><link rel="prefetch" href="/vuepress/assets/js/33.b7ad2e8e.js"><link rel="prefetch" href="/vuepress/assets/js/34.f59e295f.js"><link rel="prefetch" href="/vuepress/assets/js/35.d200411a.js"><link rel="prefetch" href="/vuepress/assets/js/36.b94f3fd5.js"><link rel="prefetch" href="/vuepress/assets/js/37.ddc71590.js"><link rel="prefetch" href="/vuepress/assets/js/38.a788387b.js"><link rel="prefetch" href="/vuepress/assets/js/39.162e9808.js"><link rel="prefetch" href="/vuepress/assets/js/40.f0c34f21.js"><link rel="prefetch" href="/vuepress/assets/js/41.9579425d.js"><link rel="prefetch" href="/vuepress/assets/js/42.2a8be507.js"><link rel="prefetch" href="/vuepress/assets/js/43.9bee127f.js"><link rel="prefetch" href="/vuepress/assets/js/44.6afdaaec.js"><link rel="prefetch" href="/vuepress/assets/js/45.ecc58971.js"><link rel="prefetch" href="/vuepress/assets/js/5.5f552971.js"><link rel="prefetch" href="/vuepress/assets/js/6.1c9f3509.js"><link rel="prefetch" href="/vuepress/assets/js/7.e627bf76.js"><link rel="prefetch" href="/vuepress/assets/js/8.4a7ea6d0.js"><link rel="prefetch" href="/vuepress/assets/js/9.3f961077.js"><link rel="prefetch" href="/vuepress/assets/js/vendors~flowchart.83bdf470.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.6b8489ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-4698c43e><div data-v-4698c43e><div id="loader-wrapper" class="loading-wrapper" data-v-1c4f0192 data-v-4698c43e data-v-4698c43e><div class="loader-main" data-v-1c4f0192><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-6cbeab0a data-v-4698c43e data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>MyGoldenAge</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>萧瑟</span>
            
          <span data-v-6cbeab0a>2022 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-4698c43e><header class="navbar" data-v-4698c43e><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress/" class="home-link router-link-active"><!----> <span class="site-name">MyGoldenAge</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/categories/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/categories/技术/" class="nav-link"><i class="iconfont undefined"></i>
  技术
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Java/Java并发编程的艺术/" class="nav-link"><i class="iconfont undefined"></i>
  Java并发编程的艺术
</a></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress/技术文章/vue/vue01.html" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-faq"></i>
      Idea
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/Idea/王小波/" class="nav-link"><i class="iconfont undefined"></i>
  王小波
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/my-GoldenAge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-4698c43e></div> <aside class="sidebar" data-v-4698c43e><div class="personal-info-wrapper" data-v-6c8ffc9c><img src="/vuepress/avatar.png" alt="author-avatar" class="personal-img" data-v-6c8ffc9c> <h3 class="name" data-v-6c8ffc9c>
    萧瑟
  </h3> <div class="num" data-v-6c8ffc9c><div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>29</h3> <h6 data-v-6c8ffc9c>文章</h6></div> <div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>9</h3> <h6 data-v-6c8ffc9c>标签</h6></div></div> <hr data-v-6c8ffc9c></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/categories/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/categories/技术/" class="nav-link"><i class="iconfont undefined"></i>
  技术
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Java/Java并发编程的艺术/" class="nav-link"><i class="iconfont undefined"></i>
  Java并发编程的艺术
</a></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress/技术文章/vue/vue01.html" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-faq"></i>
      Idea
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/Idea/王小波/" class="nav-link"><i class="iconfont undefined"></i>
  王小波
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/my-GoldenAge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java并发编程的艺术</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/Java/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF/" aria-current="page" class="sidebar-link">Java并发编程的艺术</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/01、并发编程面临的挑战.html" class="sidebar-link">并发编程面临的挑战</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/02、线程的状态转换以及基本操作.html" class="sidebar-link">线程的状态转换以及基本操作</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/03、Java内存模型以及happens-before.html" class="sidebar-link">Java内存模型以及happens-before</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/04、彻底理解synchronized.html" class="sidebar-link">彻底理解synchronized</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/05、彻底理解volatile.html" class="sidebar-link">彻底理解volatile</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/06、你真的了解final吗？.html" class="sidebar-link">你真的了解final吗？</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/07、三大性质总结：原子性、可见性以及有序性.html" class="sidebar-link">三大性质总结：原子性、可见性以及有序性</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/08、初识Lock与AbstractQueuedSynchronizer-AQS.html" class="sidebar-link">初识Lock与AbstractQueuedSynchronizer-AQS</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/09、深入理解AbstractQueuedSynchronizer-AQS.html" class="sidebar-link">深入理解AbstractQueuedSynchronizer-AQS</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/10、ReentrantLock的重入性与公平性.html" class="sidebar-link">彻底理解ReentrantLock</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/11、深入理解读写锁ReentrantReadWriteLock.html" class="sidebar-link">深入理解读写锁ReentrantReadWriteLock</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/12、详解Condition的线程通信机制.html" class="sidebar-link">详解Condition的线程通信机制</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/13、LockSupport工具.html" class="sidebar-link">LockSupport工具</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/14、并发容器之ConcurrentHashMap-JDK1.8.html" class="sidebar-link">并发容器之ConcurrentHashMap-JDK1.8</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html" class="active sidebar-link">并发容器之ConcurrentLinkedQueue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html#_1、concurrentlinkedqueue简介" class="sidebar-link">1、ConcurrentLinkedQueue简介</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html#_2、concurrentlinkedqueue的结构" class="sidebar-link">2、ConcurrentLinkedQueue的结构</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html#_3、操作node的几个cas操作" class="sidebar-link">3、操作Node的几个CAS操作</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html#_4、offer方法" class="sidebar-link">4、offer方法</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html#_5、poll方法" class="sidebar-link">5、poll方法</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html#_6、offer方法中部分线程offer部分线程poll" class="sidebar-link">6、offer方法中部分线程offer部分线程poll</a></li></ul></li><li><a href="/vuepress/Java/Java并发编程的艺术/16、并发容器之CopyOnWriteArrayList.html" class="sidebar-link">并发容器之CopyOnWriteArrayList</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html" class="sidebar-link">并发容器之ThreadLocal</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/18、并发容器之BlockingQueue.html" class="sidebar-link">并发容器之BlockingQueue</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/19、线程池ThreadPoolExecutor实现原理.html" class="sidebar-link">线程池ThreadPoolExecutor实现原理</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/20、线程池之ScheduledThreadPoolExecutor.html" class="sidebar-link">线程池之ScheduledThreadPoolExecutor</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/21、FutureTask源码解析.html" class="sidebar-link">FutureTask源码解析</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/22、Java中atomic包中的原子操作类总结.html" class="sidebar-link">Java中atomic包中的原子操作类总结</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/23、CountDownLatch与CyclicBarrier计数器.html" class="sidebar-link">CountDownLatch与CyclicBarrier计数器</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/24、java并发工具类-Semaphore，Exchanger.html" class="sidebar-link">java并发工具类-Semaphore，Exchanger</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/25、彻底弄懂生产者--消费者问题.html" class="sidebar-link">彻底弄懂生产者--消费者问题</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6cbeab0a data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>并发容器之ConcurrentLinkedQueue</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>萧瑟</span>
            
          <span data-v-6cbeab0a>2022 - </span>
          2022
        </a></span></div></div> <div data-v-4698c43e><main class="page"><!----> <div class="page-title" style="display:none;"><h1>并发容器之ConcurrentLinkedQueue</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>萧瑟</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2022-04-06 14:15:00</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      Java
    </span><span class="tag-item" data-v-484a899e>
      Java并发编程
    </span><span class="tag-item" data-v-484a899e>
      JUC
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p class="custom-block-title">说明</p> <p>并发容器之ConcurrentLinkedQueue</p></div> <p></p><div class="table-of-contents"><ul><li><a href="#_1、concurrentlinkedqueue简介">1、ConcurrentLinkedQueue简介</a></li><li><a href="#_2、concurrentlinkedqueue的结构">2、ConcurrentLinkedQueue的结构</a></li><li><a href="#_3、操作node的几个cas操作">3、操作Node的几个CAS操作</a></li><li><a href="#_4、offer方法">4、offer方法</a><ul><li><a href="#单线程角度执行分析">单线程角度执行分析</a></li><li><a href="#多线程角度执行分析">多线程角度执行分析</a></li></ul></li><li><a href="#_5、poll方法">5、poll方法</a><ul><li><a href="#单线程角度执行分析">单线程角度执行分析</a></li><li><a href="#多线程角度执行分析">多线程角度执行分析</a></li></ul></li><li><a href="#_6、offer方法中部分线程offer部分线程poll">6、offer方法中部分线程offer部分线程poll</a></li></ul></div><p></p> <h1 id="并发容器之concurrentlinkedqueue"><a href="#并发容器之concurrentlinkedqueue" class="header-anchor">#</a> 并发容器之ConcurrentLinkedQueue</h1> <h2 id="_1、concurrentlinkedqueue简介"><a href="#_1、concurrentlinkedqueue简介" class="header-anchor">#</a> 1、ConcurrentLinkedQueue简介</h2> <p>在单线程编程中我们会经常用到一些集合类，比如ArrayList,HashMap等，但是这些类都不是线程安全的类。在面试中也经常会有一些考点，比如ArrayList不是线程安全的，Vector是线程安全。而保障Vector线程安全的方式，是非常粗暴的在方法上用synchronized独占锁，将多线程执行变成串行化。要想将ArrayList变成线程安全的也可以使用<code>Collections.synchronizedList(List&lt;T&gt; list)</code>方法ArrayList转换成线程安全的，但这种转换方式依然是通过synchronized修饰方法实现的，很显然这不是一种高效的方式，同时，队列也是我们常用的一种数据结构，为了解决线程安全的问题，Doug Lea大师为我们准备了ConcurrentLinkedQueue这个线程安全的队列。从类名就可以看的出来实现队列的数据结构是链式。</p> <p>ConcurrentLinkedQueue是一个基于链接节点的无界线程安全队列，它采用先进先出的规则对节点进行排序，当我们添加一个元素的时候，它会添加到队列的尾部；当我们获取一个元素时，它会返回队列头部的元素。它采用了“wait-free”算法（即CAS算法）来实现，该算法在 Michael&amp;Scott 算法上进行了一些修改。</p> <h2 id="_2、concurrentlinkedqueue的结构"><a href="#_2、concurrentlinkedqueue的结构" class="header-anchor">#</a> 2、ConcurrentLinkedQueue的结构</h2> <p>通过ConcurrentLinkedQueue的类图来分析一下它的结构，如图所示：</p> <p><img src="/vuepress/assets/img/image-20220411152150611.edcc8591.png" alt="image-20220411152150611"></p> <p>ConcurrentLinkedQueue由head节点和tail节点组成，每个节点（Node）由数据域（item）和指向下一个节点（next）的引用组成，节点与节点之间就是通过这个next关联起来，从而组成一张链表结构的队列。默认情况下head节点存储的元素为空，tail节点等于head节点，当我们调用无参构造器时，其源码为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    head <span class="token operator">=</span> tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_3、操作node的几个cas操作"><a href="#_3、操作node的几个cas操作" class="header-anchor">#</a> 3、操作Node的几个CAS操作</h2> <p>在队列进行出队入队的时候免不了对节点需要进行操作，在多线程就很容易出现线程安全的问题。可以看出在处理器指令集能够支持<strong>CMPXCHG</strong>指令后，在java源码中涉及到并发处理都会使用CAS操作，那么在ConcurrentLinkedQueue对Node的CAS操作有这样几个：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//更改Node中的数据域item</span>
<span class="token keyword">boolean</span> <span class="token function">casItem</span><span class="token punctuation">(</span><span class="token class-name">E</span> cmp<span class="token punctuation">,</span> <span class="token class-name">E</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> itemOffset<span class="token punctuation">,</span> cmp<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//更改Node中的指针域next</span>
<span class="token keyword">void</span> <span class="token function">lazySetNext</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    UNSAFE<span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nextOffset<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//更改Node中的指针域next</span>
<span class="token keyword">boolean</span> <span class="token function">casNext</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> cmp<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nextOffset<span class="token punctuation">,</span> cmp<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以看出这些方法实际上是通过调用UNSAFE实例的方法，UNSAFE为<strong>sun.misc.Unsafe</strong>类，该类是hotspot底层方法，目前为止了解即可，知道CAS的操作归根结底是由该类提供就好。</p> <h2 id="_4、offer方法"><a href="#_4、offer方法" class="header-anchor">#</a> 4、offer方法</h2> <p>对一个队列来说，插入满足FIFO特性，插入元素总是在队列最末尾的地方进行插入，而取（移除）元素总是从队列的队头。所有要想能够彻底弄懂ConcurrentLinkedQueue自然而然是从offer方法和poll方法开始。另外，在看多线程的代码时，可采用这样的思维方式：</p> <blockquote><p><strong>单个线程offer</strong></p> <p><strong>多个线程offer</strong></p> <p><strong>部分线程offer，部分线程poll</strong></p> <ul><li>当offer的速度快于poll：队列长度会越来越长，由于offer节点总是在对队列队尾，而poll节点总是在队列对头，也就是说offer线程和poll线程两者并无“交集”，也就是说两类线程间并不会相互影响，这种情况站在相对速率的角度来看，也就是一个&quot;单线程offer&quot;</li> <li>当offer的速度慢于poll：poll的相对速率快于offer，也就是队头删的速度要快于队尾添加节点的速度，导致的结果就是队列长度会越来越短，而offer线程和poll线程就会出现“交集”，即那一时刻就可以称之为offer线程和poll线程同时操作的节点为 <strong>临界点</strong> ，且在该节点offer线程和poll线程必定相互影响。根据在临界点时offer和poll发生的相对顺序又可从两个角度去思考：<strong>1. 执行顺序为offer--&gt;poll--&gt;offer</strong>，即表现为当offer线程在Node1后插入Node2时，此时poll线程已经将Node1删除，这种情况很显然需要在offer方法中考虑； <strong>2.执行顺序可能为：poll--&gt;offer--&gt;poll</strong>，即表现为当poll线程准备删除的节点为null时（队列为空队列），此时offer线程插入一个节点使得队列变为非空队列。</li></ul></blockquote> <p>先给出offer的源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> tail<span class="token punctuation">,</span> p <span class="token operator">=</span> t<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// p is last node</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Successful CAS is the linearization point</span>
                <span class="token comment">// for e to become an element of this queue,</span>
                <span class="token comment">// and for newNode to become &quot;live&quot;.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> t<span class="token punctuation">)</span> <span class="token comment">// hop two nodes at a time</span>
                    <span class="token function">casTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Failure is OK.</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Lost CAS race to another thread; re-read next</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> q<span class="token punctuation">)</span>
            <span class="token comment">// We have fallen off list.  If tail is unchanged, it</span>
            <span class="token comment">// will also be off-list, in which case we need to</span>
            <span class="token comment">// jump to head, from which all live nodes are always</span>
            <span class="token comment">// reachable.  Else the new tail is a better bet.</span>
            p <span class="token operator">=</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> t <span class="token operator">:</span> head<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// Check for tail updates after two hops.</span>
            p <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> t <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> t <span class="token operator">:</span> q<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>下面是IDEA版本的代码，我们就以以下面的为例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、对是否为null进行判断，为null的话就直接抛出空指针异常</span>
    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、把数据E包装成Node类</span>
    <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3、将当前尾结点引用为两个变量（这里将var4认为是真正的尾结点）</span>
    <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tail<span class="token punctuation">;</span>
    <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var4 <span class="token operator">=</span> var3<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">//4、死循环，符合CAS的套路</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//5、将var4的next节点引用为var5</span>
            <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var5 <span class="token operator">=</span> var4<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var5 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>var4 <span class="token operator">==</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                var4 <span class="token operator">=</span> var3 <span class="token operator">!=</span> <span class="token punctuation">(</span>var3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tail<span class="token punctuation">)</span> <span class="token operator">?</span> var3 <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//6、定位真正的尾结点</span>
                var4 <span class="token operator">=</span> var4 <span class="token operator">!=</span> var3 <span class="token operator">&amp;&amp;</span> var3 <span class="token operator">!=</span> <span class="token punctuation">(</span>var3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tail<span class="token punctuation">)</span> <span class="token operator">?</span> var3 <span class="token operator">:</span> var5<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>var4<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//7、设置新的tail</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var4 <span class="token operator">!=</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">casTail</span><span class="token punctuation">(</span>var3<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>再执行这么一段代码，创建一个ConcurrentLinkedQueue实例，先offer 1，然后再offer 2，然后从源码的角度来逐步分析。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="单线程角度执行分析"><a href="#单线程角度执行分析" class="header-anchor">#</a> 单线程角度执行分析</h3> <p>先从<strong>单线程执行的角度</strong>看起，分析offer 1的过程。注释1代码会对是否为null进行判断，为null的话就直接抛出空指针异常，注释2代码将var1包装成一个Node类，这里实例变量var3被初始化为tail，var4被初始化为var3即tail。为了方便下面的理解，<strong>var4被认为队列真正的尾节点，tail不一定指向对象真正的尾节点，因为在ConcurrentLinkedQueue中tail是被延迟更新的</strong>，具体原因我们慢慢来看。下面进入do循环，注释4死循环，符合CAS的套路：先将var4的next节点引用为var5并看是否为null，这里明显为null，至此跳出注释4的死循环。紧接着while判断<code>!var4.casNext((ConcurrentLinkedQueue.Node)null, var2)</code>，将var4（当前真正的尾结点）的next节点变为var2，返回true取反为false，退出do while循环。执行最后的if，判断<code>var4 != var3</code>，明显是相等的，因为刚才上面根本就没动过这两个变量。至此<code>offer(1);</code>完成。此时ConcurrentLinkedQueue的状态如下图所示：</p> <p><img src="data:image/png;base64,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" alt="offer1后队列的状态"></p> <p>如图，此时队列的尾节点应该为Node1，而tail指向的节点依然还是Node0，因此可以说明tail是延迟更新的。那么我们继续来看offer 2的时候的情况，很显然此时注释5代码var5指向的节点不为null了，而是指向Node1，注释5代码if判断为false，紧接着if判断<code>var4 == var5</code>，为啥要这么判断呢，其实他们俩相等只有一种可能就是var4节点和var4的next节点都等于空，表示这个队列刚初始化，正准备添加节点，所以将head节点赋予var4（真正的尾结点）这里肯定是不相等的，于是走else代码，明显var3是等于var4的，至此var4（真正的尾结点）变为var5（也就是我们新插入的item为2的Node2节点），到这就可以彻底理解&quot;tail是被延迟更新的&quot;这句话，而其实<strong>注释6代码的作用就是定位真正的尾结点</strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>var4 <span class="token operator">=</span> var4 <span class="token operator">!=</span> var3 <span class="token operator">&amp;&amp;</span> var3 <span class="token operator">!=</span> <span class="token punctuation">(</span>var3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tail<span class="token punctuation">)</span> <span class="token operator">?</span> var3 <span class="token operator">:</span> var5<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后while里通过casNext方法设置var4节点的next为当前新增的Node2，跳出do while循环。这个时候var4 != var3（上面重新定位到了tail），注释7代码if判断为true，会通过<code>casTail(t, newNode)</code>将当前节点Node2设置为队列的队尾节点，此时的队列状态示意图如下图所示：</p> <p><img src="data:image/png;base64,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" alt="队列offer 2后的状态.png"></p> <p><strong>tail指向的节点由Node0改变为Node2</strong>，如果这里的casTail失败，是不需要重试的，原因是：offer代码中主要是通过var4的next节点var5<code>ConcurrentLinkedQueue.Node var5 = var4.next;</code>决定后面的逻辑走向的，当casTail失败时状态示意图如下：</p> <p><img src="/vuepress/assets/img/队列进行入队操作后casTail失败后的状态图.0efca00f.png" alt="队列进行入队操作后casTail失败后的状态图.png"></p> <p>如图，<strong>如果这里casTail设置tail失败即tail还是指向Node0节点的话，无非就是多循环几次通过13行代码定位到队尾节点</strong>。</p> <p>通过对单线程执行角度进行分析，我们可以了解到offer的执行逻辑为：</p> <ol><li><strong>如果tail指向的节点的下一个节点（next域）为null的话，说明tail指向的节点即为队列真正的队尾节点，因此可以通过casNext插入当前待插入的节点，但此时tail并未变化，如图2;</strong></li> <li><strong>如果tail指向的节点的下一个节点（next域）不为null的话，说明tail指向的节点不是队列的真正队尾节点。通过var5 <code>ConcurrentLinkedQueue.Node var5 = var4.next;</code>指针往前递进去找到队尾节点，然后通过casNext插入当前待插入的节点，并通过casTail方式更改tail，如图3</strong>。</li></ol> <p>不得不赞叹这个do while循环的巧妙，将原本臃肿的代码写的如此优美！</p> <p>我们回过头再来看<code>var4 = var4 != var3 &amp;&amp; var3 != (var3 = this.tail) ? var3 : var5;</code>这行代码在单线程中，这段代码永远不会将var4赋值为var3，那么这么写就不会有任何作用，那我们试着在<strong>多线程</strong>的情况下进行分析。</p> <h3 id="多线程角度执行分析"><a href="#多线程角度执行分析" class="header-anchor">#</a> 多线程角度执行分析</h3> <blockquote><p><strong>多个线程offer</strong></p></blockquote> <p>很显然这么写另有深意，其实在<strong>多线程环境</strong>下这行代码很有意思的。 <code>var3 != (var3 = this.tail)</code>这个操作<strong>并非一个原子操作</strong>，有这样一种情况：</p> <p><img src="/vuepress/assets/img/多个线程offer.ebd6a63f.jpg" alt="多个线程offer"></p> <p>如图，假设线程A此时读取了变量t，线程B刚好在这个时候offer一个Node后，此时会修改tail指针，那么这个时候线程A再次执行var4=this.tail时var4会指向另外一个节点，很显然线程A前后两次读取的变量var4指向的节点不相同，即<code>var4 != (var4 = this.tail)</code>为true，并且由于var4指向节点的变化<code>var4 != var3</code>也为true，此时该三目表达式会将var3赋给var4（其实也就是发现了多线程改动，导致这次的tail先不动），然后下面的if也不会成立，其实跟上面casTail设置tail失败的情况一样，等到下次再设置tail。</p> <blockquote><p><strong>offer-&gt;poll-&gt;offer</strong></p></blockquote> <p>那么还剩下第11行的代码我们没有分析，大致可以猜想到应该就是回答<strong>一部分线程offer，一部分poll</strong>的这种情况。当<code>if (var4 == var5)</code>为true时，说明p指向的节点的next也指向它自己，这种节点称之为<strong>哨兵节点</strong>，<strong>这种节点在队列中存在的价值不大，一般表示为要删除的节点或者是空节点</strong>。为了能够很好的理解这种情况，我们先看看poll方法的执行过程后，再回过头来看，总之这是一个很有意思的事情。</p> <h2 id="_5、poll方法"><a href="#_5、poll方法" class="header-anchor">#</a> 5、poll方法</h2> <p>poll方法源码为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    restartFromHead<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> h <span class="token operator">=</span> head<span class="token punctuation">,</span> p <span class="token operator">=</span> h<span class="token punctuation">,</span> q<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">E</span> item <span class="token operator">=</span> p<span class="token punctuation">.</span>item<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">casItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Successful CAS is the linearization point</span>
                <span class="token comment">// for item to be removed from this queue.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> h<span class="token punctuation">)</span> <span class="token comment">// hop two nodes at a time</span>
                    <span class="token function">updateHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> q <span class="token operator">:</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> item<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">updateHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> q<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> restartFromHead<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                p <span class="token operator">=</span> q<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>下面是IDEA版本的代码，我们就以以下面的为例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1、外层循环</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>
        <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var2 <span class="token operator">=</span> var1<span class="token punctuation">;</span>

        <span class="token comment">//2、内层循环</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> var4 <span class="token operator">=</span> var2<span class="token punctuation">.</span>item<span class="token punctuation">;</span>
            <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span> var3<span class="token punctuation">;</span>
            <span class="token comment">//3</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var4 <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> var2<span class="token punctuation">.</span><span class="token function">casItem</span><span class="token punctuation">(</span>var4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//6</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>var2 <span class="token operator">!=</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateHead</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> <span class="token punctuation">(</span>var3 <span class="token operator">=</span> var2<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> var3 <span class="token operator">:</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> var4<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//4、看队列中是否有下一个节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>var3 <span class="token operator">=</span> var2<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateHead</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//5、定位新的head节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var2 <span class="token operator">==</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            var2 <span class="token operator">=</span> var3<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="单线程角度执行分析-2"><a href="#单线程角度执行分析-2" class="header-anchor">#</a> 单线程角度执行分析</h3> <p>我们还是先站在<strong>单线程的角度</strong>去理清该方法的基本逻辑。假设ConcurrentLinkedQueue初始状态如下图所示：</p> <p><img src="data:image/png;base64,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" alt="队列初始状态.png"></p> <p>参照上面offer方法，上来直接进行一个死循环，分别将当前的头节点（head）引用为var1和var2，而这里的<strong>var2也是代表队列真正的head节点</strong>。里面又是一个死循环，将var2节点的数据（item）引用为var4，然后再来一个var3（Node）节点，但未初始化。下面if判断var4是否为null，看数据是否为空，并且将var2的数据域（item）置空<code>var2.casItem(var4, (Object)null)</code>。这里如果CAS item失败或者var4为空则此次循环结束等待下一次循环进行重试。当然这里if判断为true，紧接着下面的if判断var1和var2是否相等，这里肯定是相等的（其实经过上面对offer方法的分析，我们大概知道这个if判断是为了防止多线程的干扰），所以为false，返回var4<code>Object var4 = var2.item;</code>，方法结束。此时的队列状态如下图：</p> <p><img src="data:image/png;base64,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" alt="队列出队操作后的状态.png"></p> <p>下面继续从队列中poll，很显然当前var1和var2指向的Node1的数据域为null，那么第一件事就是要<strong>定位准备删除的队头节点(找到数据域不为null的节点)</strong>。</p> <blockquote><p><strong>定位删除的队头节点</strong></p></blockquote> <p>直接来到注释3代码，由于上面poll Node1时已将其item域置空，所以注释3代码的if为false。来到注释4代码的if判断，var2.next是否为null，不为null，if判断为false。来到注释5代码if判断var3（上面一个if判断将var2.next赋予var3）和var2是否相等，如果相等退出注释2循环，重新开始注释1外层循环，这里是不相等的，就将var3赋给var2，<strong>也就是找到真正的head节点</strong>，然后进行下一次注释2的内侧循环。再来到注释3代码，var4（Node2节点的item域）不为空，并用<code>var2.casItem(var4, (Object)null)</code>将var2（Node2节点）的item域置空，来到注释6的if判断<code>var2 != var1</code>，由于上一次内层循环已经改变了var2 <code>var2 = var3;</code>，所以if判断为true，执行<code>this.updateHead(var1, (var3 = var2.next) != null ? var3 : var2);</code>，而<code>(var3 = var2.next) != null ? var3 : var2)</code>就是看Node2节点后面有没有节点了有的话就是Node2节点后面一个节点，没有的话就是Node2节点，这里的casItem方法源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">updateHead</span><span class="token punctuation">(</span><span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> var1<span class="token punctuation">,</span> <span class="token class-name">ConcurrentLinkedQueue<span class="token punctuation">.</span>Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var1 <span class="token operator">!=</span> var2 <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">casHead</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        var1<span class="token punctuation">.</span><span class="token function">lazySetNext</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>该方法主要是通过<code>casHead</code>将队列的head指向Node3，并且通过 <code>var1.lazySetNext</code>将Node1的next域指向它自己（其实就是废弃Node1等待GC回收）。最后返回var4，也就是Node2节点的数据（item）。此时队列的状态如下图所示：</p> <p><img src="/vuepress/assets/img/Node2从队列中出队后的状态.03b8375c.png" alt="Node2从队列中出队后的状态.png"></p> <p>Node1的next域指向它自己，head指向了Node3。以上的分析是从单线程执行的角度去看，也可以让我们了解poll的整体思路，现在来做一个总结：</p> <ol><li><strong>如果当前head，var1和var2指向的节点的Item不为null的话，说明该节点即为真正的队头节点（待删除节点），只需要通过casItem方法将item域设置为null,然后将原来的item直接返回即可。</strong></li> <li><strong>如果当前head，var1和var2指向的节点的item为null的话，则说明该节点不是真正的待删除节点，那么应该做的就是寻找item不为null的节点。通过让var3指向var2的下一个节点（var3 = var2.next）进行试探，若找到则通过updateHead方法更新head指向的节点以及构造哨兵节点（通过updateHead方法的<code>var1.lazySetNext(h)</code>）</strong>。</li></ol> <h3 id="多线程角度执行分析-2"><a href="#多线程角度执行分析-2" class="header-anchor">#</a> 多线程角度执行分析</h3> <blockquote><p><strong>多个线程poll</strong></p></blockquote> <p>现在回过头来看poll方法的源码，有这样一部分：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>var2 <span class="token operator">==</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这一部分就是处理多个线程poll的情况，<code>var3 = var2.next</code>也就是说var3永远指向的是var2的下一个节点，那么什么情况下会使得var2，var3指向同一个节点呢？根据上面我们的分析，只有var2指向的节点在poll的时候转变成了<strong>哨兵节点</strong>（通过updateHead方法中的var1.lazySetNext）。当线程A在判断<code>var2 == var3</code>时，线程B已经将执行完poll方法将var2指向的节点转换为<strong>哨兵节点</strong>并且head指向的节点已经发生了改变，所以就需要从外层循环处重新开始，保证用到的是最新的head。</p> <blockquote><p><strong>poll-&gt;offer-&gt;poll</strong></p></blockquote> <p>试想，还有这样一种情况，如果当前队列为空队列，线程A进行poll操作，同时线程B执行offer，然后线程A在执行poll，那么此时线程A返回的是null还是线程B刚插入的最新的那个节点呢？我们来写一代demo：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> value <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; poll 的值为：&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;queue当前是否为空队列：&quot;</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        queue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>输出结果为：</p> <blockquote><p>Thread-0 poll 的值为：null</p> <p>queue当前是否为空队列：false</p></blockquote> <p>通过debug控制线程thread1和线程thread2的执行顺序，thread1先执行到代码<code>if ((var3 = var2.next) == null)</code>，由于此时队列为空队列if判断为true，进入if块，此时先让thread1暂停，然后thread2进行offer插入值为1的节点后，thread2执行结束。再让thread1执行，这时<strong>thread1并没有进行重试</strong>，而是代码继续往下走，返回null，尽管此时队列由于thread2已经插入了值为1的新的节点。所以输出结果为thread0 poll的为null，然队列不为空队列。因此，<strong>在判断队列是否为空队列的时候是不能通过线程在poll的时候返回为null进行判断的，可以通过isEmpty方法进行判断</strong>。</p> <h2 id="_6、offer方法中部分线程offer部分线程poll"><a href="#_6、offer方法中部分线程offer部分线程poll" class="header-anchor">#</a> 6、offer方法中部分线程offer部分线程poll</h2> <p>在分析offer方法的时候我们还留下了一个问题，即对offer方法中<code>if (p == q)</code>代码的理解。</p> <blockquote><p><strong>offer-&gt;poll-&gt;offer</strong></p></blockquote> <p>在offer方法的第11行代码<code>if (p == q)</code>，能够让if判断为true的情况为p指向的节点为<strong>哨兵节点</strong>，而什么时候会构造哨兵节点呢？在对poll方法的讨论中，我们已经找到了答案，即**当head指向的节点的item域为null时会寻找真正的队头节点，等到待插入的节点插入之后，会更新head，并且将原来head指向的节点设置为哨兵节点。**假设队列初始状态如下图所示：</p> <p><img src="data:image/png;base64,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" alt="offer和poll相互影响分析时队列初始状态.png"></p> <p>因此在线程A执行offer时，线程B执行poll就会存在如下一种情况：</p> <p><img src="/vuepress/assets/img/线程A和线程B可能存在的执行时序.4b7ffae4.png" alt="线程A和线程B可能存在的执行时序.png"></p> <p>如图，线程A的tail节点存在next节点Node1，因此会通过引用q往前寻找队列真正的队尾节点，当执行到判断<code>if (p == q)</code>时，此时线程B执行poll操作，在对线程B来说，head和p指向Node0，由于Node0的item域为null，同样会往前递进找到队列真正的队头节点Node1,在线程B执行完poll之后，Node0就会转换为<strong>哨兵节点</strong>，也就意味着队列的head发生了改变，此时队列状态为下图：</p> <p><img src="/vuepress/assets/img/线程B进行poll后队列的状态图.6a7d9dc9.png" alt="线程B进行poll后队列的状态图.png"></p> <p>此时线程A在执行判断<code>if (p == q)</code>时就为true，会继续执行<code>p = (t != (t = tail)) ? t : head;</code>，由于tail指针没有发生改变所以p被赋值为head，重新从head开始完成插入操作。</p> <h1 id="_5-hops的设计"><a href="#_5-hops的设计" class="header-anchor">#</a> 5. HOPS的设计</h1> <p>通过上面对offer和poll方法的分析，我们发现tail和head是延迟更新的，两者更新触发时机为：</p> <p><strong>tail更新触发时机</strong>：当tail指向的节点的下一个节点不为null的时候，会执行定位队列真正的队尾节点的操作，找到队尾节点后完成插入之后才会通过casTail进行tail更新；当tail指向的节点的下一个节点为null的时候，只插入节点不更新tail。</p> <p><strong>head更新触发时机</strong>：当head指向的节点的item域为null的时候，会执行定位队列真正的队头节点的操作，找到队头节点后完成删除之后才会通过updateHead进行head更新；当head指向的节点的item域不为null的时候，只删除节点不更新head。</p> <p>并且在更新操作时，源码中会有注释为：<strong>hop two nodes at a time</strong>。所以这种延迟更新的策略就被叫做HOPS的大概原因是这个（猜的 ），从上面更新时的状态图可以看出，head和tail的更新是“跳着的”即中间总是间隔了一个。那么这样设计的意图是什么呢？</p> <p>如果让tail永远作为队列的队尾节点，实现的代码量会更少，而且逻辑更易懂。但是，这样做有一个缺点，**如果大量的入队操作，每次都要执行CAS进行tail的更新，汇总起来对性能也会是大大的损耗。如果能减少CAS更新的操作，无疑可以大大提升入队的操作效率，所以doug lea大师每间隔1次（tail和队尾节点的距离为1）才利用CAS更新tail。**对head的更新也是同样的道理，虽然，这样设计会多出在循环中定位队尾节点，但总体来说读的操作效率要远远高于写的性能，因此，多出来的在循环中定位尾节点的操作的性能损耗相对而言是很小的。</p> <blockquote><p>参考资料</p></blockquote> <p>《java并发编程的艺术》</p> <p>《Java高并发程序设计》</p> <p><a href="https://github.com/CL0610/Java-concurrency/blob/master/15.%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BConcurrentLinkedQueue/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BConcurrentLinkedQueue.md#4-offer%E6%96%B9%E6%B3%95%E4%B8%AD%E9%83%A8%E5%88%86%E7%BA%BF%E7%A8%8Boffer%E9%83%A8%E5%88%86%E7%BA%BF%E7%A8%8Bpoll" target="_blank" rel="noopener noreferrer">并发容器之ConcurrentLinkedQueue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">上次更新：: </span> <span class="time">6/19/2022, 4:51:37 PM</span></div></footer> <!----> <!----></main> <!----> <div class="comments-wrapper" data-v-4698c43e><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div><!----><div></div><!----><APlayer audio="" fixed="true" mini="true" theme="#282c34" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="0" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/vuepress/assets/js/app.1688b474.js" defer></script><script src="/vuepress/assets/js/4.87cca1e2.js" defer></script><script src="/vuepress/assets/js/1.e3a634da.js" defer></script><script src="/vuepress/assets/js/10.33f4d679.js" defer></script><script src="/vuepress/assets/js/23.18ff150a.js" defer></script>
  </body>
</html>
