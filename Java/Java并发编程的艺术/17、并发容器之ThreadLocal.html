<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>并发容器之ThreadLocal | MyGoldenAge</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/img/favicon.ico">
    <link rel="stylesheet" href="/vuepress/css/style.css">
    <script charset="utf-8" src="/vuepress/js/custom.js"></script>
    <meta name="description" content="并发容器之ThreadLocal">
    <meta name="keywords" content="全栈,黄金时代">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="author" content="萧瑟">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.6b8489ed.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.1688b474.js" as="script"><link rel="preload" href="/vuepress/assets/js/4.87cca1e2.js" as="script"><link rel="preload" href="/vuepress/assets/js/1.e3a634da.js" as="script"><link rel="preload" href="/vuepress/assets/js/20.9ff399c5.js" as="script"><link rel="preload" href="/vuepress/assets/js/23.18ff150a.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.33f4d679.js"><link rel="prefetch" href="/vuepress/assets/js/11.633d59fc.js"><link rel="prefetch" href="/vuepress/assets/js/12.6566debe.js"><link rel="prefetch" href="/vuepress/assets/js/13.813b91b9.js"><link rel="prefetch" href="/vuepress/assets/js/14.0508579e.js"><link rel="prefetch" href="/vuepress/assets/js/15.bea71415.js"><link rel="prefetch" href="/vuepress/assets/js/16.d5a87820.js"><link rel="prefetch" href="/vuepress/assets/js/17.a3ea973d.js"><link rel="prefetch" href="/vuepress/assets/js/18.cdcd3e86.js"><link rel="prefetch" href="/vuepress/assets/js/19.f57142c1.js"><link rel="prefetch" href="/vuepress/assets/js/21.bab6863c.js"><link rel="prefetch" href="/vuepress/assets/js/22.551758a7.js"><link rel="prefetch" href="/vuepress/assets/js/24.97cc5fe7.js"><link rel="prefetch" href="/vuepress/assets/js/25.ef5f5151.js"><link rel="prefetch" href="/vuepress/assets/js/26.d8424825.js"><link rel="prefetch" href="/vuepress/assets/js/27.fe42ac28.js"><link rel="prefetch" href="/vuepress/assets/js/28.306a195b.js"><link rel="prefetch" href="/vuepress/assets/js/29.15b3a25f.js"><link rel="prefetch" href="/vuepress/assets/js/30.f58e0ff8.js"><link rel="prefetch" href="/vuepress/assets/js/31.189d9dfa.js"><link rel="prefetch" href="/vuepress/assets/js/32.904cde6d.js"><link rel="prefetch" href="/vuepress/assets/js/33.b7ad2e8e.js"><link rel="prefetch" href="/vuepress/assets/js/34.f59e295f.js"><link rel="prefetch" href="/vuepress/assets/js/35.d200411a.js"><link rel="prefetch" href="/vuepress/assets/js/36.b94f3fd5.js"><link rel="prefetch" href="/vuepress/assets/js/37.ddc71590.js"><link rel="prefetch" href="/vuepress/assets/js/38.a788387b.js"><link rel="prefetch" href="/vuepress/assets/js/39.162e9808.js"><link rel="prefetch" href="/vuepress/assets/js/40.f0c34f21.js"><link rel="prefetch" href="/vuepress/assets/js/41.9579425d.js"><link rel="prefetch" href="/vuepress/assets/js/42.2a8be507.js"><link rel="prefetch" href="/vuepress/assets/js/43.9bee127f.js"><link rel="prefetch" href="/vuepress/assets/js/44.6afdaaec.js"><link rel="prefetch" href="/vuepress/assets/js/45.ecc58971.js"><link rel="prefetch" href="/vuepress/assets/js/5.5f552971.js"><link rel="prefetch" href="/vuepress/assets/js/6.1c9f3509.js"><link rel="prefetch" href="/vuepress/assets/js/7.e627bf76.js"><link rel="prefetch" href="/vuepress/assets/js/8.4a7ea6d0.js"><link rel="prefetch" href="/vuepress/assets/js/9.3f961077.js"><link rel="prefetch" href="/vuepress/assets/js/vendors~flowchart.83bdf470.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.6b8489ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-4698c43e><div data-v-4698c43e><div id="loader-wrapper" class="loading-wrapper" data-v-1c4f0192 data-v-4698c43e data-v-4698c43e><div class="loader-main" data-v-1c4f0192><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div><div data-v-1c4f0192></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-6cbeab0a data-v-4698c43e data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>MyGoldenAge</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>萧瑟</span>
            
          <span data-v-6cbeab0a>2022 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-4698c43e><header class="navbar" data-v-4698c43e><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress/" class="home-link router-link-active"><!----> <span class="site-name">MyGoldenAge</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/categories/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/categories/技术/" class="nav-link"><i class="iconfont undefined"></i>
  技术
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Java/Java并发编程的艺术/" class="nav-link"><i class="iconfont undefined"></i>
  Java并发编程的艺术
</a></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress/技术文章/vue/vue01.html" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-faq"></i>
      Idea
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/Idea/王小波/" class="nav-link"><i class="iconfont undefined"></i>
  王小波
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/my-GoldenAge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-4698c43e></div> <aside class="sidebar" data-v-4698c43e><div class="personal-info-wrapper" data-v-6c8ffc9c><img src="/vuepress/avatar.png" alt="author-avatar" class="personal-img" data-v-6c8ffc9c> <h3 class="name" data-v-6c8ffc9c>
    萧瑟
  </h3> <div class="num" data-v-6c8ffc9c><div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>29</h3> <h6 data-v-6c8ffc9c>文章</h6></div> <div data-v-6c8ffc9c><h3 data-v-6c8ffc9c>9</h3> <h6 data-v-6c8ffc9c>标签</h6></div></div> <hr data-v-6c8ffc9c></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/categories/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/categories/技术/" class="nav-link"><i class="iconfont undefined"></i>
  技术
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Java/Java并发编程的艺术/" class="nav-link"><i class="iconfont undefined"></i>
  Java并发编程的艺术
</a></li><li class="dropdown-item"><h4>前端</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress/技术文章/vue/vue01.html" class="nav-link"><i class="iconfont undefined"></i>
  前端基础
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-faq"></i>
      Idea
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/Idea/" class="nav-link"><i class="iconfont undefined"></i>
  Idea
</a></li><li class="dropdown-item"><!----> <a href="/vuepress/Idea/王小波/" class="nav-link"><i class="iconfont undefined"></i>
  王小波
</a></li></ul></div></div><div class="nav-item"><a href="/vuepress/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="https://github.com/my-GoldenAge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java并发编程的艺术</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress/Java/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF/" aria-current="page" class="sidebar-link">Java并发编程的艺术</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/01、并发编程面临的挑战.html" class="sidebar-link">并发编程面临的挑战</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/02、线程的状态转换以及基本操作.html" class="sidebar-link">线程的状态转换以及基本操作</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/03、Java内存模型以及happens-before.html" class="sidebar-link">Java内存模型以及happens-before</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/04、彻底理解synchronized.html" class="sidebar-link">彻底理解synchronized</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/05、彻底理解volatile.html" class="sidebar-link">彻底理解volatile</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/06、你真的了解final吗？.html" class="sidebar-link">你真的了解final吗？</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/07、三大性质总结：原子性、可见性以及有序性.html" class="sidebar-link">三大性质总结：原子性、可见性以及有序性</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/08、初识Lock与AbstractQueuedSynchronizer-AQS.html" class="sidebar-link">初识Lock与AbstractQueuedSynchronizer-AQS</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/09、深入理解AbstractQueuedSynchronizer-AQS.html" class="sidebar-link">深入理解AbstractQueuedSynchronizer-AQS</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/10、ReentrantLock的重入性与公平性.html" class="sidebar-link">彻底理解ReentrantLock</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/11、深入理解读写锁ReentrantReadWriteLock.html" class="sidebar-link">深入理解读写锁ReentrantReadWriteLock</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/12、详解Condition的线程通信机制.html" class="sidebar-link">详解Condition的线程通信机制</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/13、LockSupport工具.html" class="sidebar-link">LockSupport工具</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/14、并发容器之ConcurrentHashMap-JDK1.8.html" class="sidebar-link">并发容器之ConcurrentHashMap-JDK1.8</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/15、并发容器之ConcurrentLinkedQueue.html" class="sidebar-link">并发容器之ConcurrentLinkedQueue</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/16、并发容器之CopyOnWriteArrayList.html" class="sidebar-link">并发容器之CopyOnWriteArrayList</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html" class="active sidebar-link">并发容器之ThreadLocal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html#_1、threadlocal的简介" class="sidebar-link">1、ThreadLocal的简介</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html#_2、threadlocal的实现原理" class="sidebar-link">2、ThreadLocal的实现原理</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html#_3、threadlocalmap详解" class="sidebar-link">3、ThreadLocalMap详解</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html#_4、threadlocal的使用场景" class="sidebar-link">4、ThreadLocal的使用场景</a></li><li class="sidebar-sub-header"><a href="/vuepress/Java/Java并发编程的艺术/17、并发容器之ThreadLocal.html#_5、threadlocal最佳实践" class="sidebar-link">5、ThreadLocal最佳实践</a></li></ul></li><li><a href="/vuepress/Java/Java并发编程的艺术/18、并发容器之BlockingQueue.html" class="sidebar-link">并发容器之BlockingQueue</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/19、线程池ThreadPoolExecutor实现原理.html" class="sidebar-link">线程池ThreadPoolExecutor实现原理</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/20、线程池之ScheduledThreadPoolExecutor.html" class="sidebar-link">线程池之ScheduledThreadPoolExecutor</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/21、FutureTask源码解析.html" class="sidebar-link">FutureTask源码解析</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/22、Java中atomic包中的原子操作类总结.html" class="sidebar-link">Java中atomic包中的原子操作类总结</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/23、CountDownLatch与CyclicBarrier计数器.html" class="sidebar-link">CountDownLatch与CyclicBarrier计数器</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/24、java并发工具类-Semaphore，Exchanger.html" class="sidebar-link">java并发工具类-Semaphore，Exchanger</a></li><li><a href="/vuepress/Java/Java并发编程的艺术/25、彻底弄懂生产者--消费者问题.html" class="sidebar-link">彻底弄懂生产者--消费者问题</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6cbeab0a data-v-4698c43e><h3 class="title" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a>并发容器之ThreadLocal</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><input type="password" value="" data-v-6cbeab0a> <span data-v-6cbeab0a>Konck! Knock!</span> <button data-v-6cbeab0a>OK</button></label> <div class="footer" style="display:none;" data-v-6cbeab0a data-v-6cbeab0a><span data-v-6cbeab0a><i class="iconfont reco-theme" data-v-6cbeab0a></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6cbeab0a>vuePress-theme-reco</a></span> <span data-v-6cbeab0a><i class="iconfont reco-copyright" data-v-6cbeab0a></i> <a data-v-6cbeab0a><span data-v-6cbeab0a>萧瑟</span>
            
          <span data-v-6cbeab0a>2022 - </span>
          2022
        </a></span></div></div> <div data-v-4698c43e><main class="page"><!----> <div class="page-title" style="display:none;"><h1>并发容器之ThreadLocal</h1> <hr> <div data-v-484a899e><i class="iconfont reco-account" data-v-484a899e><span data-v-484a899e>萧瑟</span></i> <i class="iconfont reco-date" data-v-484a899e><span data-v-484a899e>2022-04-08 14:15:00</span></i> <!----> <i class="iconfont reco-tag tags" data-v-484a899e><span class="tag-item" data-v-484a899e>
      Java
    </span><span class="tag-item" data-v-484a899e>
      Java并发编程
    </span><span class="tag-item" data-v-484a899e>
      JUC
    </span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><div class="custom-block tip"><p class="custom-block-title">说明</p> <p>并发容器之ThreadLocal</p></div> <p></p><div class="table-of-contents"><ul><li><a href="#_1、threadlocal的简介">1、ThreadLocal的简介</a></li><li><a href="#_2、threadlocal的实现原理">2、ThreadLocal的实现原理</a></li><li><a href="#_3、threadlocalmap详解">3、ThreadLocalMap详解</a><ul><li><a href="#_3-1-entry数据结构">3.1 Entry数据结构</a></li><li><a href="#_3-2-set方法">3.2 set方法</a></li><li><a href="#_3-3-getentry方法">3.3 getEntry方法</a></li><li><a href="#_3-4-remove方法">3.4 remove方法</a></li></ul></li><li><a href="#_4、threadlocal的使用场景">4、ThreadLocal的使用场景</a></li><li><a href="#_5、threadlocal最佳实践">5、ThreadLocal最佳实践</a></li></ul></div><p></p> <h1 id="并发容器之threadlocal"><a href="#并发容器之threadlocal" class="header-anchor">#</a> 并发容器之ThreadLocal</h1> <h2 id="_1、threadlocal的简介"><a href="#_1、threadlocal的简介" class="header-anchor">#</a> 1、ThreadLocal的简介</h2> <p>threadLocal是为了解决<strong>对象不能被多线程共享访问</strong>的问题，通过threadLocal.set方法将对象实例保存在每个线程自己所拥有的threadLocalMap中，这样每个线程使用自己的对象实例，彼此不会影响达到隔离的作用，从而就解决了对象在被共享访问带来线程安全问题。如果将同步机制和threadLocal做一个横向比较的话，同步机制就是通过控制线程访问共享对象的顺序，而threadLocal就是为每一个线程分配一个该对象，各用各的互不影响。打个比方说，现在有100个同学需要填写一张表格但是只有一支笔，同步就相当于A使用完这支笔后给B，B使用后给C用......老师就控制着这支笔的使用顺序，使得同学之间不会产生冲突。而threadLocal就相当于，老师直接准备了100支笔，这样每个同学都使用自己的，同学之间就不会产生冲突。很显然这就是两种不同的思路，同步机制以“<strong>时间换空间</strong>”，由于每个线程在同一时刻共享对象只能被一个线程访问造成整体上响应时间增加，但是对象只占有一份内存，牺牲了时间效率换来了空间效率即“时间换空间”。而threadLocal，为每个线程都分配了一份对象，自然而然内存使用率增加，每个线程各用各的，整体上时间效率要增加很多，牺牲了空间效率换来时间效率即“<strong>空间换时间</strong>”。</p> <p>虽然ThreadLocal并不在java.util.concurrent包中而在java.lang包中，但我更倾向于把它当作是一种并发容器（虽然真正存放数据的是ThreadLoclMap）进行归类。从<strong>ThreadLocal这个类名可以顾名思义的进行理解，表示线程的“本地变量”，即每个线程都拥有该变量副本，达到人手一份的效果，各用各的这样就可以避免共享资源的竞争</strong>。</p> <h2 id="_2、threadlocal的实现原理"><a href="#_2、threadlocal的实现原理" class="header-anchor">#</a> 2、ThreadLocal的实现原理</h2> <p>要想学习到ThreadLocal的实现原理，就必须了解它的几个核心方法，包括怎样存怎样取等等，下面我们一个个来看。</p> <blockquote><p><strong>void set(T value)</strong></p></blockquote> <p><strong>set方法设置在当前线程中threadLocal变量的值</strong>，该方法的源码为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 获取当前线程实例对象</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 通过当前线程实例获取到ThreadLocalMap对象</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">//3. 如果Map不为null,则以当前threadLocl实例为key,值为value进行存入</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">//4.map为null,则新建ThreadLocalMap并存入value</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>方法的逻辑很清晰，具体请看上面的注释。通过源码我们知道value是存放在了ThreadLocalMap里了，当前先把它理解为一个普普通通的map即可，也就是说，<strong>数据value是真正的存放在了ThreadLocalMap这个容器中了，并且是以当前threadLocal实例为key</strong>。先简单的看下ThreadLocalMap是什么，有个简单的认识就好，下面会具体说的。</p> <p><strong>首先ThreadLocalMap是怎样来的</strong>？源码很清楚，是通过<code>getMap(t)</code>进行获取：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该方法直接返回的就是当前线程对象t的一个成员变量threadLocals：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/* ThreadLocal values pertaining to this thread. This map is maintained
 * by the ThreadLocal class. */</span>
<span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是说<strong>ThreadLocalMap的引用是作为Thread的一个成员变量，被Thread进行维护的</strong>。回过头再来看看set方法，当map为Null的时候会通过<code>createMap(t，value)</code>方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该方法就是<strong>new一个ThreadLocalMap实例对象，然后同样以当前threadLocal实例作为key，值为value存放到threadLocalMap中，然后将当前线程对象的threadLocals赋值为threadLocalMap</strong>。</p> <p>现在来对set方法进行总结一下： <strong>通过当前线程对象thread获取该thread所维护的threadLocalMap，若threadLocalMap不为null，则以threadLocal实例为key，值为value的键值对存入threadLocalMap，若threadLocalMap为null的话，就新建threadLocalMap然后在以threadLocal为键，值为value的键值对存入即可。</strong></p> <blockquote><p><strong>T get()</strong></p></blockquote> <p><strong>get方法是获取当前线程中threadLocal变量的值</strong>，同样的还是来看看源码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1. 获取当前线程的实例对象</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 获取当前线程的threadLocalMap</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//3. 获取map中当前threadLocal实例为key的值的entry</span>
        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">//4. 当前entitiy不为null的话，就返回相应的值value</span>
            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//5. 若map为null或者entry为null的话通过该方法初始化，并返回该方法返回的value</span>
    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>弄懂了set方法的逻辑，看get方法只需要带着逆向思维去看就好，如果是那样存的，反过来去拿就好。代码逻辑请看注释，另外，看下setInitialValue主要做了些什么事情？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这段方法的逻辑和set方法几乎一致，另外值得关注的是initialValue方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这个<strong>方法是protected修饰的也就是说继承ThreadLocal的子类可重写该方法，实现赋值为其他的初始值</strong>。</p> <p>关于get方法来总结一下：<strong>通过当前线程thread实例获取到它所维护的threadLocalMap，然后以当前threadLocal实例为key获取该map中的键值对（Entry），若Entry不为null则返回Entry的value。如果获取threadLocalMap为null或者Entry为null的话，就以当前threadLocal为Key，value为null存入map后，并返回null。</strong></p> <blockquote><p><strong>void remove()</strong></p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//1. 获取当前线程的threadLocalMap</span>
	<span class="token class-name">ThreadLocalMap</span> m <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
		<span class="token comment">//2. 从map中删除以当前threadLocal实例为key的键值对</span>
		m<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>get，set方法实现了存数据和读数据，我们当然还得学会如何删数据。<strong>删除数据当然是从map中删除数据，先获取与当前线程相关联的threadLocalMap然后从map中删除该threadLocal实例为key的键值对即可</strong>。</p> <h2 id="_3、threadlocalmap详解"><a href="#_3、threadlocalmap详解" class="header-anchor">#</a> 3、ThreadLocalMap详解</h2> <p>从上面的分析我们已经知道，数据其实都放在了threadLocalMap中，threadLocal的get，set和remove方法实际上具体是通过threadLocalMap的getEntry，set和remove方法实现的。如果想真正全方位的弄懂threadLocal，势必得在对threadLocalMap做一番理解。</p> <p>首先threadLocalMap是threadLocal的内部静态类，而Entry是threadLocalMap的内部静态类。</p> <h3 id="_3-1-entry数据结构"><a href="#_3-1-entry数据结构" class="header-anchor">#</a> 3.1 Entry数据结构</h3> <p>ThreadLocalMap是threadLocal一个静态内部类，和大多数容器一样内部维护了一个数组，同样的threadLocalMap内部维护了一个Entry类型的table数组。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * The table, resized as necessary.
 * table.length MUST always be a power of two.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过注释可以看出，table数组的长度为2的幂次方。接下来看下Entry是什么：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/** The value associated with this ThreadLocal. */</span>
    <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

    <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Entry是一个以ThreadLocal为key，Object为value的键值对，另外需要注意的是这里的<strong>threadLocal是弱引用，因为Entry继承了WeakReference，在Entry的构造方法中，调用了super(k)方法就会将threadLocal实例包装成一个WeakReferenece</strong>。到这里我们可以用一个图来理解下thread，threadLocal，threadLocalMap，Entry之间的关系：</p> <p><img src="/vuepress/assets/img/ThreadLocal各引用间的关系.dcb5e4eb.png" alt="ThreadLocal各引用间的关系.png"></p> <p>注意上图中的实线表示强引用，虚线表示弱引用。如图所示，每个线程实例中可以通过threadLocals获取到threadLocalMap，而threadLocalMap实际上就是一个以threadLocal实例为key，任意对象为value的Entry数组。当我们为threadLocal变量赋值，实际上就是用以当前threadLocal实例为key，值为value的Entry往这个threadLocalMap中存放。</p> <p>需要注意的是**Entry中的key是弱引用，当threadLocal外部强引用被置为null(<code>threadLocalInstance = null</code>)，那么系统 GC 的时候，根据可达性分析，这个threadLocal实例就没有任何一条链路能够引用到它，这个ThreadLocal势必会被回收，这样一来，ThreadLocalMap中就会出现key为null的Entry，就没有办法访问这些key为null的Entry的value，如果当前线程再迟迟不结束的话，这些key为null的Entry的value就会一直存在一条强引用链：Thread Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value永远无法回收，造成内存泄漏。**当然，如果当前thread运行结束，threadLocal，threadLocalMap，Entry没有引用链可达，在垃圾回收的时候都会被系统进行回收。</p> <p>在实际开发中，会使用线程池去维护线程的创建和复用，比如固定大小的线程池，线程为了复用是不会主动结束的，所以，threadLocal的内存泄漏问题，是应该值得我们思考和注意的问题，关于这个问题可以看这篇文章----<a href="http://www.jianshu.com/p/dde92ec37bd1" target="_blank" rel="noopener noreferrer">详解threadLocal内存泄漏问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_3-2-set方法"><a href="#_3-2-set方法" class="header-anchor">#</a> 3.2 set方法</h3> <p>与concurrentHashMap，hashMap等容器一样，threadLocalMap也是采用散列表进行实现的。在了解set方法前，我们先来回顾下关于散列表相关的知识（也可以查看<a href="https://sentinel-22.github.io/#/%E6%A1%86%E6%9E%B6%E6%9E%B6%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%93%88%E5%B8%8C%E8%A1%A8" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）：</p> <ul><li>散列表</li></ul> <p>理想状态下，散列表就是一个包含关键字的固定大小的数组，通过使用散列函数，将关键字映射到数组的不同位置。</p> <p><img src="data:image/png;base64,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LBeJQqTBDRDrldI+0P8AB1n1FI6a3DcAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDItMDJUMTE6NTY6MTcrMDg6MDDAR6hUAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAyLTAyVDExOjU2OjE3KzA4OjAwsRoQ6AAAAE50RVh0c29mdHdhcmUASW1hZ2VNYWdpY2sgNi45LjEtMTAgUTE2IHg4Nl82NCAyMDE3LTEyLTIxIGh0dHA6Ly93d3cuaW1hZ2VtYWdpY2sub3JnPPF+OQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMjgxwgmv9wAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAyMDjg/c0GAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE1MTc1NDM3NzdRHfDKAAAAEnRFWHRUaHVtYjo6U2l6ZQAzLjZLQkI+/ZnIAAAAR3RFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vd29ya3NwYWNlL3RtcC9pbWd2aWV3Ml85XzM1ZTlmYWYxZTRhMTFhXzVmNWVkXzMwOFswXRaX01kAAAAASUVORK5CYII=" alt="理想散列表的一个示意图.png"></p> <p>下面是在理想状态下，哈希函数可以将关键字均匀的分散到数组的不同位置，不会出现两个关键字散列值相同（假设关键字数量小于数组的大小）的情况。但是在实际使用中，经常会出现多个关键字散列值相同的情况（被映射到数组的同一个位置），我们将这种情况称为散列冲突。为了解决散列冲突，主要采用下面两种方式： <strong>分离链表法</strong>（separate chaining）和<strong>开放定址法</strong>（open addressing）</p> <ul><li><strong>分离链表法</strong></li></ul> <p>分散链表法使用链表解决冲突，将散列值相同的元素都保存到一个链表中。当查询的时候，首先找到元素所在的链表，然后遍历链表查找对应的元素，典型实现为hashMap，concurrentHashMap的拉链法。下面是一个示意图：</p> <p><img src="data:image/gif;base64,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" alt="分离链表法示意图.gif"></p> <ul><li><strong>开放定址法</strong></li></ul> <p>开放定址法不会创建链表，当关键字散列到的数组单元已经被另外一个关键字占用的时候，就会尝试在数组中寻找其他的单元，直到找到一个空的单元。探测数组空单元的方式有很多，这里介绍一种最简单的 -- 线性探测法。线性探测法就是从冲突的数组单元开始，依次往后搜索空单元，如果到数组尾部，再从头开始搜索（环形查找）。如下图所示：</p> <p><img src="/vuepress/assets/img/开放定址法示意图.fb39832d.jpg" alt="开放定址法示意图.jpg"></p> <p>关于两种方式的比较，可以参考 <a href="http://www.nowamagic.net/academy/detail/3008060" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<strong>ThreadLocalMap 中使用开放地址法来处理散列冲突</strong>，而 HashMap 中使用的分离链表法。之所以采用不同的方式主要是因为：在 ThreadLocalMap 中的散列值分散的十分均匀，很少会出现冲突。并且 ThreadLocalMap 经常需要清除无用的对象，使用纯数组更加方便。</p> <p>在了解这些相关知识后我们再回过头来看一下set方法。set方法的源码为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// We don't use a fast path as with get() because it is at</span>
    <span class="token comment">// least as common to use set() to create new entries as</span>
    <span class="token comment">// it is to replace existing ones, in which case, a fast</span>
    <span class="token comment">// path would fail more often than not.</span>

    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">//根据threadLocal的hashCode确定Entry应该存放的位置</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//采用开放地址法，hash冲突的时候使用线性探测</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//覆盖旧Entry</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//当key为null时，说明threadLocal强引用已经被释放掉，那么就无法</span>
        <span class="token comment">//再通过这个key获取threadLocalMap中对应的entry，这里就存在内存泄漏的可能性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//用当前插入的值替换掉这个key为null的“脏”entry</span>
            <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//新建entry并插入table中i处</span>
    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
    <span class="token comment">//插入后再次清除一些key为null的“脏”entry,如果大于阈值就需要扩容</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
        <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>set方法的关键部分<strong>请看上面的注释</strong>，主要有这样几点需要注意：</p> <ol><li><strong>threadLocal的hashcode?</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadLocalHashCode <span class="token operator">=</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> HASH_INCREMENT <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> nextHashCode <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">/**
  * Returns the next hash code.
  */</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span>HASH_INCREMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>从源码中我们可以清楚的看到threadLocal实例的hashCode是通过nextHashCode()方法实现的，该方法实际上总是用一个AtomicInteger加上0x61c88647来实现的。0x61c88647这个数是有特殊意义的，它能够保证hash表的每个散列桶能够均匀的分布，这是<code>Fibonacci Hashing</code>，关于更多介绍可以看<a href="https://www.cnblogs.com/zhangjk1993/archive/2017/03/29/6641745.html" target="_blank" rel="noopener noreferrer">这篇文章的threadLocal散列值部分<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。也正是能够均匀分布，所以threadLocal选择使用开放地址法来解决hash冲突的问题。</p> <ol start="2"><li><strong>怎样确定新值插入到哈希表中的位置？</strong></li></ol> <p>该操作源码为：<code>key.threadLocalHashCode &amp; (len-1)</code>，同hashMap和ConcurrentHashMap等容器的方式一样，利用当前key(即threadLocal实例)的hashcode与哈希表大小相比，因为哈希表大小总是为2的幂次方，所以相与等同于一个取模的过程，这样就可以通过Key分配到具体的哈希桶中去。而至于为什么取模要通过位与运算的原因就是位运算的执行效率远远高于了取模运算。</p> <ol start="3"><li><strong>怎样解决hash冲突？</strong></li></ol> <p>源码中通过<code>nextIndex(i, len)</code>方法解决hash冲突的问题，该方法为<code>((i + 1 &lt; len) ? i + 1 : 0);</code>，也就是不断往后线性探测，当到哈希表末尾的时候再从0开始，成环形。</p> <ol start="4"><li><strong>怎样解决“脏”Entry？</strong></li></ol> <p>在分析threadLocal，threadLocalMap以及Entry的关系的时候，我们已经知道使用threadLocal有可能存在内存泄漏（对象创建出来后，在之后的逻辑一直没有使用该对象，但是垃圾回收器无法回收这个部分的内存），在源码中针对这种key为null的Entry称之为“stale entry”，直译为不新鲜的entry，我把它理解为“脏entry”，自然而然，Josh Bloch and Doug Lea大师考虑到了这种情况，在set方法的for循环中寻找和当前Key相同的可覆盖entry的过程中通过<strong>replaceStaleEntry</strong>方法解决脏entry的问题。如果当前table[i]为null的话，直接插入新entry后也会通过<strong>cleanSomeSlots</strong>来解决脏entry的问题，关于cleanSomeSlots和replaceStaleEntry方法，会在详解threadLocal内存泄漏中讲到，具体可看那篇文章。</p> <ol start="5"><li><strong>如何进行扩容？</strong></li></ol> <blockquote><p>threshold的确定</p></blockquote> <p>也几乎和大多数容器一样，threadLocalMap会有扩容机制，那么它的threshold又是怎样确定的了？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token keyword">private</span> <span class="token keyword">int</span> threshold<span class="token punctuation">;</span> <span class="token comment">// Default to 0</span>
	<span class="token comment">/**
     * The initial capacity -- MUST be a power of two.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

    <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> firstKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>INITIAL_CAPACITY<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> firstKey<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>INITIAL_CAPACITY <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>firstKey<span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">setThreshold</span><span class="token punctuation">(</span>INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">/**
     * Set the resize threshold to maintain at worst a 2/3 load factor.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        threshold <span class="token operator">=</span> len <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>根据源码可知，在第一次为threadLocal进行赋值的时候会创建初始大小为16的threadLocalMap，并且通过setThreshold方法设置threshold，其值为当前哈希数组长度乘以（2/3），也就是说加载因子为2/3(<strong>加载因子是衡量哈希表密集程度的一个参数，如果加载因子越大的话，说明哈希表被装载的越多，出现hash冲突的可能性越大，反之，则被装载的越少，出现hash冲突的可能性越小。同时如果过小，很显然内存使用率不高，该值取值应该考虑到内存使用率和hash冲突概率的一个平衡，如hashMap，concurrentHashMap的加载因子都为0.75</strong>)。这里<strong>threadLocalMap初始大小为16</strong>，<strong>加载因子为2/3</strong>，所以哈希表可用大小为：16*2/3=10，即哈希表可用容量为10。</p> <blockquote><p>扩容resize</p></blockquote> <p>从set方法中可以看出当hash表的size大于threshold的时候，会通过resize方法进行扩容。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Double the capacity of the table.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldLen <span class="token operator">=</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
	<span class="token comment">//新数组为原数组的2倍</span>
    <span class="token keyword">int</span> newLen <span class="token operator">=</span> oldLen <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>newLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//遍历过程中如果遇到脏entry的话直接另value为null,有助于value能够被回收</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Help the GC</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">//重新确定entry在新数组的位置，然后进行插入</span>
                <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//设置新哈希表的threshHold和size属性</span>
    <span class="token function">setThreshold</span><span class="token punctuation">(</span>newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> count<span class="token punctuation">;</span>
    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>方法逻辑<strong>请看注释</strong>，新建一个大小为原来数组长度的两倍的数组，然后遍历旧数组中的entry并将其插入到新的hash数组中，主要注意的是，<strong>在扩容的过程中针对脏entry的话会令value为null，以便能够被垃圾回收器能够回收，解决隐藏的内存泄漏的问题</strong>。</p> <h3 id="_3-3-getentry方法"><a href="#_3-3-getentry方法" class="header-anchor">#</a> 3.3 getEntry方法</h3> <p>getEntry方法源码为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//1. 确定在散列数组中的位置</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//2. 根据索引i获取entry</span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//3. 满足条件则返回该entry</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
		<span class="token comment">//4. 未查找到满足条件的entry，额外在做的处理</span>
        <span class="token keyword">return</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>方法逻辑很简单，若能当前定位的entry的key和查找的key相同的话就直接返回这个entry，否则的话就是在set的时候存在hash冲突的情况，需要通过getEntryAfterMiss做进一步处理。getEntryAfterMiss方法为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">Entry</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span>
			<span class="token comment">//找到和查询的key相同的entry则返回</span>
            <span class="token keyword">return</span> e<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
			<span class="token comment">//解决脏entry的问题</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
			<span class="token comment">//继续向后环形查找</span>
            i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这个方法同样很好理解，通过nextIndex往后环形查找，如果找到和查询的key相同的entry的话就直接返回，如果在查找过程中遇到脏entry的话使用expungeStaleEntry方法进行处理。到目前为止**，为了解决潜在的内存泄漏的问题，在set，resize，getEntry这些地方都会对这些脏entry进行处理，可见为了尽可能解决这个问题几乎无时无刻都在做出努力。**</p> <h3 id="_3-4-remove方法"><a href="#_3-4-remove方法" class="header-anchor">#</a> 3.4 remove方法</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Remove the entry for key.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//将entry的key置为null</span>
            e<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//将该entry的value也置为null</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>该方法逻辑很简单，通过往后环形查找到与指定key相同的entry后，先通过clear方法将key置为null后，使其转换为一个脏entry，然后调用expungeStaleEntry方法将其value置为null，以便垃圾回收时能够清理，同时将table[i]置为null。</p> <h2 id="_4、threadlocal的使用场景"><a href="#_4、threadlocal的使用场景" class="header-anchor">#</a> 4、ThreadLocal的使用场景</h2> <p><strong>ThreadLocal 不是用来解决共享对象的多线程访问问题的</strong>，数据实质上是放在每个thread实例引用的threadLocalMap，也就是说<strong>每个不同的线程都拥有专属于自己的数据容器（threadLocalMap），彼此不影响</strong>。因此threadLocal只适用于 <strong>共享对象会造成线程安全</strong> 的业务场景。比如<strong>hibernate中通过threadLocal管理Session</strong>就是一个典型的案例，不同的请求线程（用户）拥有自己的session，若将session共享出去被多线程访问，必然会带来线程安全问题。下面，我们自己来写一个例子，SimpleDateFormat.parse方法会有线程安全的问题，我们可以尝试使用threadLocal包装SimpleDateFormat，将该实例不被多线程共享即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DateUtil</span><span class="token punctuation">(</span><span class="token string">&quot;2019-11-25 09:00:&quot;</span> <span class="token operator">+</span> i <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DateUtil</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> date<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">DateUtil</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>date <span class="token operator">=</span> date<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sdf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Date</span> date <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ol><li>如果当前线程不持有SimpleDateformat对象实例，那么就新建一个并把它设置到当前线程中，如果已经持有，就直接使用。另外，<strong>从<code>if (sdf.get() == null){....}else{.....}</code>可以看出为每一个线程分配一个SimpleDateformat对象实例是从应用层面（业务代码逻辑）去保证的。</strong></li> <li>在上面我们说过threadLocal有可能存在内存泄漏，在使用完之后，最好使用remove方法将这个变量移除，就像在使用数据库连接一样，及时关闭连接。</li></ol> <h2 id="_5、threadlocal最佳实践"><a href="#_5、threadlocal最佳实践" class="header-anchor">#</a> 5、ThreadLocal最佳实践</h2> <p>上面说ThreadLocal有内存泄漏问题，对那么实践中我们应该怎么做？</p> <ol><li>每次使用完ThreadLocal，都调用它的remove()方法，清除数据。</li> <li>在使用线程池的情况下，没有及时清理ThreadLocal，不仅是内存泄漏的问题，更严重的是可能导致业务逻辑出现问题。所以，使用ThreadLocal就跟加锁完要解锁一样，用完就清理。</li></ol> <blockquote><p>参考资料</p></blockquote> <p>《java高并发程序设计》</p> <p><a href="https://github.com/CL0610/Java-concurrency/blob/master/17.%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BThreadLocal/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BThreadLocal.md" target="_blank" rel="noopener noreferrer">并发容器之ThreadLocal<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">上次更新：: </span> <span class="time">6/19/2022, 4:51:37 PM</span></div></footer> <!----> <!----></main> <!----> <div class="comments-wrapper" data-v-4698c43e><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-44bd5a18 data-v-44bd5a18><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-44bd5a18><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-44bd5a18></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-44bd5a18></path></svg></div><!----><div></div><!----><APlayer audio="" fixed="true" mini="true" theme="#282c34" loop="loop" order="list" preload="auto" volume="0.7" mutex="true" lrc-type="0" list-max-height="250" storage-name="vuepress-plugin-meting" id="aplayer-fixed"></APlayer></div></div>
    <script src="/vuepress/assets/js/app.1688b474.js" defer></script><script src="/vuepress/assets/js/4.87cca1e2.js" defer></script><script src="/vuepress/assets/js/1.e3a634da.js" defer></script><script src="/vuepress/assets/js/20.9ff399c5.js" defer></script><script src="/vuepress/assets/js/23.18ff150a.js" defer></script>
  </body>
</html>
