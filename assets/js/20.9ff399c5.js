(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{700:function(s,a,t){s.exports=t.p+"assets/img/ThreadLocal各引用间的关系.dcb5e4eb.png"},701:function(s,a){s.exports="data:image/png;base64,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LBeJQqTBDRDrldI+0P8AB1n1FI6a3DcAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDItMDJUMTE6NTY6MTcrMDg6MDDAR6hUAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAyLTAyVDExOjU2OjE3KzA4OjAwsRoQ6AAAAE50RVh0c29mdHdhcmUASW1hZ2VNYWdpY2sgNi45LjEtMTAgUTE2IHg4Nl82NCAyMDE3LTEyLTIxIGh0dHA6Ly93d3cuaW1hZ2VtYWdpY2sub3JnPPF+OQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMjgxwgmv9wAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAyMDjg/c0GAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE1MTc1NDM3NzdRHfDKAAAAEnRFWHRUaHVtYjo6U2l6ZQAzLjZLQkI+/ZnIAAAAR3RFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vd29ya3NwYWNlL3RtcC9pbWd2aWV3Ml85XzM1ZTlmYWYxZTRhMTFhXzVmNWVkXzMwOFswXRaX01kAAAAASUVORK5CYII="},702:function(s,a){s.exports="data:image/gif;base64,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"},703:function(s,a,t){s.exports=t.p+"assets/img/开放定址法示意图.fb39832d.jpg"},762:function(s,a,t){"use strict";t.r(a);var n=t(6),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("说明")]),s._v(" "),n("p",[s._v("并发容器之ThreadLocal")])]),s._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#_1、threadlocal的简介"}},[s._v("1、ThreadLocal的简介")])]),n("li",[n("a",{attrs:{href:"#_2、threadlocal的实现原理"}},[s._v("2、ThreadLocal的实现原理")])]),n("li",[n("a",{attrs:{href:"#_3、threadlocalmap详解"}},[s._v("3、ThreadLocalMap详解")]),n("ul",[n("li",[n("a",{attrs:{href:"#_3-1-entry数据结构"}},[s._v("3.1 Entry数据结构")])]),n("li",[n("a",{attrs:{href:"#_3-2-set方法"}},[s._v("3.2 set方法")])]),n("li",[n("a",{attrs:{href:"#_3-3-getentry方法"}},[s._v("3.3 getEntry方法")])]),n("li",[n("a",{attrs:{href:"#_3-4-remove方法"}},[s._v("3.4 remove方法")])])])]),n("li",[n("a",{attrs:{href:"#_4、threadlocal的使用场景"}},[s._v("4、ThreadLocal的使用场景")])]),n("li",[n("a",{attrs:{href:"#_5、threadlocal最佳实践"}},[s._v("5、ThreadLocal最佳实践")])])])]),n("p"),s._v(" "),n("h1",{attrs:{id:"并发容器之threadlocal"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发容器之threadlocal"}},[s._v("#")]),s._v(" 并发容器之ThreadLocal")]),s._v(" "),n("h2",{attrs:{id:"_1、threadlocal的简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、threadlocal的简介"}},[s._v("#")]),s._v(" 1、ThreadLocal的简介")]),s._v(" "),n("p",[s._v("threadLocal是为了解决"),n("strong",[s._v("对象不能被多线程共享访问")]),s._v("的问题，通过threadLocal.set方法将对象实例保存在每个线程自己所拥有的threadLocalMap中，这样每个线程使用自己的对象实例，彼此不会影响达到隔离的作用，从而就解决了对象在被共享访问带来线程安全问题。如果将同步机制和threadLocal做一个横向比较的话，同步机制就是通过控制线程访问共享对象的顺序，而threadLocal就是为每一个线程分配一个该对象，各用各的互不影响。打个比方说，现在有100个同学需要填写一张表格但是只有一支笔，同步就相当于A使用完这支笔后给B，B使用后给C用......老师就控制着这支笔的使用顺序，使得同学之间不会产生冲突。而threadLocal就相当于，老师直接准备了100支笔，这样每个同学都使用自己的，同学之间就不会产生冲突。很显然这就是两种不同的思路，同步机制以“"),n("strong",[s._v("时间换空间")]),s._v("”，由于每个线程在同一时刻共享对象只能被一个线程访问造成整体上响应时间增加，但是对象只占有一份内存，牺牲了时间效率换来了空间效率即“时间换空间”。而threadLocal，为每个线程都分配了一份对象，自然而然内存使用率增加，每个线程各用各的，整体上时间效率要增加很多，牺牲了空间效率换来时间效率即“"),n("strong",[s._v("空间换时间")]),s._v("”。")]),s._v(" "),n("p",[s._v("虽然ThreadLocal并不在java.util.concurrent包中而在java.lang包中，但我更倾向于把它当作是一种并发容器（虽然真正存放数据的是ThreadLoclMap）进行归类。从"),n("strong",[s._v("ThreadLocal这个类名可以顾名思义的进行理解，表示线程的“本地变量”，即每个线程都拥有该变量副本，达到人手一份的效果，各用各的这样就可以避免共享资源的竞争")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"_2、threadlocal的实现原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、threadlocal的实现原理"}},[s._v("#")]),s._v(" 2、ThreadLocal的实现原理")]),s._v(" "),n("p",[s._v("要想学习到ThreadLocal的实现原理，就必须了解它的几个核心方法，包括怎样存怎样取等等，下面我们一个个来看。")]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("void set(T value)")])])]),s._v(" "),n("p",[n("strong",[s._v("set方法设置在当前线程中threadLocal变量的值")]),s._v("，该方法的源码为：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//1. 获取当前线程实例对象")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//2. 通过当前线程实例获取到ThreadLocalMap对象")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),s._v(" map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//3. 如果Map不为null,则以当前threadLocl实例为key,值为value进行存入")]),s._v("\n        map"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//4.map为null,则新建ThreadLocalMap并存入value")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("方法的逻辑很清晰，具体请看上面的注释。通过源码我们知道value是存放在了ThreadLocalMap里了，当前先把它理解为一个普普通通的map即可，也就是说，"),n("strong",[s._v("数据value是真正的存放在了ThreadLocalMap这个容器中了，并且是以当前threadLocal实例为key")]),s._v("。先简单的看下ThreadLocalMap是什么，有个简单的认识就好，下面会具体说的。")]),s._v(" "),n("p",[n("strong",[s._v("首先ThreadLocalMap是怎样来的")]),s._v("？源码很清楚，是通过"),n("code",[s._v("getMap(t)")]),s._v("进行获取：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocals"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("该方法直接返回的就是当前线程对象t的一个成员变量threadLocals：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* ThreadLocal values pertaining to this thread. This map is maintained\n * by the ThreadLocal class. */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ThreadLocalMap")]),s._v(" threadLocals "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("也就是说"),n("strong",[s._v("ThreadLocalMap的引用是作为Thread的一个成员变量，被Thread进行维护的")]),s._v("。回过头再来看看set方法，当map为Null的时候会通过"),n("code",[s._v("createMap(t，value)")]),s._v("方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" firstValue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocals "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" firstValue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("该方法就是"),n("strong",[s._v("new一个ThreadLocalMap实例对象，然后同样以当前threadLocal实例作为key，值为value存放到threadLocalMap中，然后将当前线程对象的threadLocals赋值为threadLocalMap")]),s._v("。")]),s._v(" "),n("p",[s._v("现在来对set方法进行总结一下： "),n("strong",[s._v("通过当前线程对象thread获取该thread所维护的threadLocalMap，若threadLocalMap不为null，则以threadLocal实例为key，值为value的键值对存入threadLocalMap，若threadLocalMap为null的话，就新建threadLocalMap然后在以threadLocal为键，值为value的键值对存入即可。")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("T get()")])])]),s._v(" "),n("p",[n("strong",[s._v("get方法是获取当前线程中threadLocal变量的值")]),s._v("，同样的还是来看看源码：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//1. 获取当前线程的实例对象")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//2. 获取当前线程的threadLocalMap")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),s._v(" map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//3. 获取map中当前threadLocal实例为key的值的entry")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Entry")]),s._v(" e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" map"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SuppressWarnings")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unchecked"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//4. 当前entitiy不为null的话，就返回相应的值value")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//5. 若map为null或者entry为null的话通过该方法初始化，并返回该方法返回的value")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setInitialValue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("弄懂了set方法的逻辑，看get方法只需要带着逆向思维去看就好，如果是那样存的，反过来去拿就好。代码逻辑请看注释，另外，看下setInitialValue主要做了些什么事情？")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setInitialValue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initialValue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),s._v(" map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("map "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        map"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("这段方法的逻辑和set方法几乎一致，另外值得关注的是initialValue方法：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("protected")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initialValue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("这个"),n("strong",[s._v("方法是protected修饰的也就是说继承ThreadLocal的子类可重写该方法，实现赋值为其他的初始值")]),s._v("。")]),s._v(" "),n("p",[s._v("关于get方法来总结一下："),n("strong",[s._v("通过当前线程thread实例获取到它所维护的threadLocalMap，然后以当前threadLocal实例为key获取该map中的键值对（Entry），若Entry不为null则返回Entry的value。如果获取threadLocalMap为null或者Entry为null的话，就以当前threadLocal为Key，value为null存入map后，并返回null。")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("void remove()")])])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("remove")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//1. 获取当前线程的threadLocalMap")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),s._v(" m "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("m "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//2. 从map中删除以当前threadLocal实例为key的键值对")]),s._v("\n\t\tm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("remove")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("get，set方法实现了存数据和读数据，我们当然还得学会如何删数据。"),n("strong",[s._v("删除数据当然是从map中删除数据，先获取与当前线程相关联的threadLocalMap然后从map中删除该threadLocal实例为key的键值对即可")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"_3、threadlocalmap详解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、threadlocalmap详解"}},[s._v("#")]),s._v(" 3、ThreadLocalMap详解")]),s._v(" "),n("p",[s._v("从上面的分析我们已经知道，数据其实都放在了threadLocalMap中，threadLocal的get，set和remove方法实际上具体是通过threadLocalMap的getEntry，set和remove方法实现的。如果想真正全方位的弄懂threadLocal，势必得在对threadLocalMap做一番理解。")]),s._v(" "),n("p",[s._v("首先threadLocalMap是threadLocal的内部静态类，而Entry是threadLocalMap的内部静态类。")]),s._v(" "),n("h3",{attrs:{id:"_3-1-entry数据结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-entry数据结构"}},[s._v("#")]),s._v(" 3.1 Entry数据结构")]),s._v(" "),n("p",[s._v("ThreadLocalMap是threadLocal一个静态内部类，和大多数容器一样内部维护了一个数组，同样的threadLocalMap内部维护了一个Entry类型的table数组。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * The table, resized as necessary.\n * table.length MUST always be a power of two.\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("通过注释可以看出，table数组的长度为2的幂次方。接下来看下Entry是什么：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("WeakReference")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/** The value associated with this ThreadLocal. */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" v"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("super")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" v"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("Entry是一个以ThreadLocal为key，Object为value的键值对，另外需要注意的是这里的"),n("strong",[s._v("threadLocal是弱引用，因为Entry继承了WeakReference，在Entry的构造方法中，调用了super(k)方法就会将threadLocal实例包装成一个WeakReferenece")]),s._v("。到这里我们可以用一个图来理解下thread，threadLocal，threadLocalMap，Entry之间的关系：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(700),alt:"ThreadLocal各引用间的关系.png"}})]),s._v(" "),n("p",[s._v("注意上图中的实线表示强引用，虚线表示弱引用。如图所示，每个线程实例中可以通过threadLocals获取到threadLocalMap，而threadLocalMap实际上就是一个以threadLocal实例为key，任意对象为value的Entry数组。当我们为threadLocal变量赋值，实际上就是用以当前threadLocal实例为key，值为value的Entry往这个threadLocalMap中存放。")]),s._v(" "),n("p",[s._v("需要注意的是**Entry中的key是弱引用，当threadLocal外部强引用被置为null("),n("code",[s._v("threadLocalInstance = null")]),s._v(")，那么系统 GC 的时候，根据可达性分析，这个threadLocal实例就没有任何一条链路能够引用到它，这个ThreadLocal势必会被回收，这样一来，ThreadLocalMap中就会出现key为null的Entry，就没有办法访问这些key为null的Entry的value，如果当前线程再迟迟不结束的话，这些key为null的Entry的value就会一直存在一条强引用链：Thread Ref -> Thread -> ThreaLocalMap -> Entry -> value永远无法回收，造成内存泄漏。**当然，如果当前thread运行结束，threadLocal，threadLocalMap，Entry没有引用链可达，在垃圾回收的时候都会被系统进行回收。")]),s._v(" "),n("p",[s._v("在实际开发中，会使用线程池去维护线程的创建和复用，比如固定大小的线程池，线程为了复用是不会主动结束的，所以，threadLocal的内存泄漏问题，是应该值得我们思考和注意的问题，关于这个问题可以看这篇文章----"),n("a",{attrs:{href:"http://www.jianshu.com/p/dde92ec37bd1",target:"_blank",rel:"noopener noreferrer"}},[s._v("详解threadLocal内存泄漏问题"),n("OutboundLink")],1)]),s._v(" "),n("h3",{attrs:{id:"_3-2-set方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-set方法"}},[s._v("#")]),s._v(" 3.2 set方法")]),s._v(" "),n("p",[s._v("与concurrentHashMap，hashMap等容器一样，threadLocalMap也是采用散列表进行实现的。在了解set方法前，我们先来回顾下关于散列表相关的知识（也可以查看"),n("a",{attrs:{href:"https://sentinel-22.github.io/#/%E6%A1%86%E6%9E%B6%E6%9E%B6%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%93%88%E5%B8%8C%E8%A1%A8",target:"_blank",rel:"noopener noreferrer"}},[s._v("这篇文章"),n("OutboundLink")],1),s._v("）：")]),s._v(" "),n("ul",[n("li",[s._v("散列表")])]),s._v(" "),n("p",[s._v("理想状态下，散列表就是一个包含关键字的固定大小的数组，通过使用散列函数，将关键字映射到数组的不同位置。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(701),alt:"理想散列表的一个示意图.png"}})]),s._v(" "),n("p",[s._v("下面是在理想状态下，哈希函数可以将关键字均匀的分散到数组的不同位置，不会出现两个关键字散列值相同（假设关键字数量小于数组的大小）的情况。但是在实际使用中，经常会出现多个关键字散列值相同的情况（被映射到数组的同一个位置），我们将这种情况称为散列冲突。为了解决散列冲突，主要采用下面两种方式： "),n("strong",[s._v("分离链表法")]),s._v("（separate chaining）和"),n("strong",[s._v("开放定址法")]),s._v("（open addressing）")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("分离链表法")])])]),s._v(" "),n("p",[s._v("分散链表法使用链表解决冲突，将散列值相同的元素都保存到一个链表中。当查询的时候，首先找到元素所在的链表，然后遍历链表查找对应的元素，典型实现为hashMap，concurrentHashMap的拉链法。下面是一个示意图：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(702),alt:"分离链表法示意图.gif"}})]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("开放定址法")])])]),s._v(" "),n("p",[s._v("开放定址法不会创建链表，当关键字散列到的数组单元已经被另外一个关键字占用的时候，就会尝试在数组中寻找其他的单元，直到找到一个空的单元。探测数组空单元的方式有很多，这里介绍一种最简单的 -- 线性探测法。线性探测法就是从冲突的数组单元开始，依次往后搜索空单元，如果到数组尾部，再从头开始搜索（环形查找）。如下图所示：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(703),alt:"开放定址法示意图.jpg"}})]),s._v(" "),n("p",[s._v("关于两种方式的比较，可以参考 "),n("a",{attrs:{href:"http://www.nowamagic.net/academy/detail/3008060",target:"_blank",rel:"noopener noreferrer"}},[s._v("这篇文章"),n("OutboundLink")],1),s._v("。"),n("strong",[s._v("ThreadLocalMap 中使用开放地址法来处理散列冲突")]),s._v("，而 HashMap 中使用的分离链表法。之所以采用不同的方式主要是因为：在 ThreadLocalMap 中的散列值分散的十分均匀，很少会出现冲突。并且 ThreadLocalMap 经常需要清除无用的对象，使用纯数组更加方便。")]),s._v(" "),n("p",[s._v("在了解这些相关知识后我们再回过头来看一下set方法。set方法的源码为：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// We don't use a fast path as with get() because it is at")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// least as common to use set() to create new entries as")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// it is to replace existing ones, in which case, a fast")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// path would fail more often than not.")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" tab "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//根据threadLocal的hashCode确定Entry应该存放的位置")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocalHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("len"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//采用开放地址法，hash冲突的时候使用线性探测")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n         e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n         e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextIndex")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" len"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//覆盖旧Entry")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//当key为null时，说明threadLocal强引用已经被释放掉，那么就无法")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//再通过这个key获取threadLocalMap中对应的entry，这里就存在内存泄漏的可能性")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//用当前插入的值替换掉这个key为null的“脏”entry")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("replaceStaleEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//新建entry并插入table中i处")]),s._v("\n    tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sz "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("size"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//插入后再次清除一些key为null的“脏”entry,如果大于阈值就需要扩容")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cleanSomeSlots")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sz"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" sz "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" threshold"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rehash")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("p",[s._v("set方法的关键部分"),n("strong",[s._v("请看上面的注释")]),s._v("，主要有这样几点需要注意：")]),s._v(" "),n("ol",[n("li",[n("strong",[s._v("threadLocal的hashcode?")])])]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" threadLocalHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextHashCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" HASH_INCREMENT "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x61c88647")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AtomicInteger")]),s._v(" nextHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AtomicInteger")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n  * Returns the next hash code.\n  */")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextHashCode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" nextHashCode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getAndAdd")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HASH_INCREMENT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("从源码中我们可以清楚的看到threadLocal实例的hashCode是通过nextHashCode()方法实现的，该方法实际上总是用一个AtomicInteger加上0x61c88647来实现的。0x61c88647这个数是有特殊意义的，它能够保证hash表的每个散列桶能够均匀的分布，这是"),n("code",[s._v("Fibonacci Hashing")]),s._v("，关于更多介绍可以看"),n("a",{attrs:{href:"https://www.cnblogs.com/zhangjk1993/archive/2017/03/29/6641745.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("这篇文章的threadLocal散列值部分"),n("OutboundLink")],1),s._v("。也正是能够均匀分布，所以threadLocal选择使用开放地址法来解决hash冲突的问题。")]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("strong",[s._v("怎样确定新值插入到哈希表中的位置？")])])]),s._v(" "),n("p",[s._v("该操作源码为："),n("code",[s._v("key.threadLocalHashCode & (len-1)")]),s._v("，同hashMap和ConcurrentHashMap等容器的方式一样，利用当前key(即threadLocal实例)的hashcode与哈希表大小相比，因为哈希表大小总是为2的幂次方，所以相与等同于一个取模的过程，这样就可以通过Key分配到具体的哈希桶中去。而至于为什么取模要通过位与运算的原因就是位运算的执行效率远远高于了取模运算。")]),s._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[n("strong",[s._v("怎样解决hash冲突？")])])]),s._v(" "),n("p",[s._v("源码中通过"),n("code",[s._v("nextIndex(i, len)")]),s._v("方法解决hash冲突的问题，该方法为"),n("code",[s._v("((i + 1 < len) ? i + 1 : 0);")]),s._v("，也就是不断往后线性探测，当到哈希表末尾的时候再从0开始，成环形。")]),s._v(" "),n("ol",{attrs:{start:"4"}},[n("li",[n("strong",[s._v("怎样解决“脏”Entry？")])])]),s._v(" "),n("p",[s._v("在分析threadLocal，threadLocalMap以及Entry的关系的时候，我们已经知道使用threadLocal有可能存在内存泄漏（对象创建出来后，在之后的逻辑一直没有使用该对象，但是垃圾回收器无法回收这个部分的内存），在源码中针对这种key为null的Entry称之为“stale entry”，直译为不新鲜的entry，我把它理解为“脏entry”，自然而然，Josh Bloch and Doug Lea大师考虑到了这种情况，在set方法的for循环中寻找和当前Key相同的可覆盖entry的过程中通过"),n("strong",[s._v("replaceStaleEntry")]),s._v("方法解决脏entry的问题。如果当前table[i]为null的话，直接插入新entry后也会通过"),n("strong",[s._v("cleanSomeSlots")]),s._v("来解决脏entry的问题，关于cleanSomeSlots和replaceStaleEntry方法，会在详解threadLocal内存泄漏中讲到，具体可看那篇文章。")]),s._v(" "),n("ol",{attrs:{start:"5"}},[n("li",[n("strong",[s._v("如何进行扩容？")])])]),s._v(" "),n("blockquote",[n("p",[s._v("threshold的确定")])]),s._v(" "),n("p",[s._v("也几乎和大多数容器一样，threadLocalMap会有扩容机制，那么它的threshold又是怎样确定的了？")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[s._v("\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" threshold"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Default to 0")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * The initial capacity -- MUST be a power of two.\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" INITIAL_CAPACITY "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalMap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" firstKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" firstValue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        table "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INITIAL_CAPACITY"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" firstKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocalHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("INITIAL_CAPACITY "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("firstKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" firstValue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setThreshold")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("INITIAL_CAPACITY"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * Set the resize threshold to maintain at worst a 2/3 load factor.\n     */")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setThreshold")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" len"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        threshold "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("根据源码可知，在第一次为threadLocal进行赋值的时候会创建初始大小为16的threadLocalMap，并且通过setThreshold方法设置threshold，其值为当前哈希数组长度乘以（2/3），也就是说加载因子为2/3("),n("strong",[s._v("加载因子是衡量哈希表密集程度的一个参数，如果加载因子越大的话，说明哈希表被装载的越多，出现hash冲突的可能性越大，反之，则被装载的越少，出现hash冲突的可能性越小。同时如果过小，很显然内存使用率不高，该值取值应该考虑到内存使用率和hash冲突概率的一个平衡，如hashMap，concurrentHashMap的加载因子都为0.75")]),s._v(")。这里"),n("strong",[s._v("threadLocalMap初始大小为16")]),s._v("，"),n("strong",[s._v("加载因子为2/3")]),s._v("，所以哈希表可用大小为：16*2/3=10，即哈希表可用容量为10。")]),s._v(" "),n("blockquote",[n("p",[s._v("扩容resize")])]),s._v(" "),n("p",[s._v("从set方法中可以看出当hash表的size大于threshold的时候，会通过resize方法进行扩容。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * Double the capacity of the table.\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" oldTab "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" oldLen "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oldTab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//新数组为原数组的2倍")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" newLen "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oldLen "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" newTab "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("newLen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" count "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" j "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" j "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" oldLen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oldTab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("j"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//遍历过程中如果遇到脏entry的话直接另value为null,有助于value能够被回收")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Help the GC")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//重新确定entry在新数组的位置，然后进行插入")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" h "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocalHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("newLen "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("newTab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("h"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                    h "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextIndex")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("h"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" newLen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                newTab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("h"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                count"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//设置新哈希表的threshHold和size属性")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setThreshold")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("newLen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    table "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" newTab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("p",[s._v("方法逻辑"),n("strong",[s._v("请看注释")]),s._v("，新建一个大小为原来数组长度的两倍的数组，然后遍历旧数组中的entry并将其插入到新的hash数组中，主要注意的是，"),n("strong",[s._v("在扩容的过程中针对脏entry的话会令value为null，以便能够被垃圾回收器能够回收，解决隐藏的内存泄漏的问题")]),s._v("。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-getentry方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-getentry方法"}},[s._v("#")]),s._v(" 3.3 getEntry方法")]),s._v(" "),n("p",[s._v("getEntry方法源码为：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//1. 确定在散列数组中的位置")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocalHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//2. 根据索引i获取entry")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//3. 满足条件则返回该entry")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//4. 未查找到满足条件的entry，额外在做的处理")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getEntryAfterMiss")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("方法逻辑很简单，若能当前定位的entry的key和查找的key相同的话就直接返回这个entry，否则的话就是在set的时候存在hash冲突的情况，需要通过getEntryAfterMiss做进一步处理。getEntryAfterMiss方法为：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("getEntryAfterMiss")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" tab "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//找到和查询的key相同的entry则返回")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//解决脏entry的问题")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("expungeStaleEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//继续向后环形查找")]),s._v("\n            i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextIndex")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" len"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("这个方法同样很好理解，通过nextIndex往后环形查找，如果找到和查询的key相同的entry的话就直接返回，如果在查找过程中遇到脏entry的话使用expungeStaleEntry方法进行处理。到目前为止**，为了解决潜在的内存泄漏的问题，在set，resize，getEntry这些地方都会对这些脏entry进行处理，可见为了尽可能解决这个问题几乎无时无刻都在做出努力。**")]),s._v(" "),n("h3",{attrs:{id:"_3-4-remove方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-remove方法"}},[s._v("#")]),s._v(" 3.4 remove方法")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * Remove the entry for key.\n */")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("remove")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" tab "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" table"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" len "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threadLocalHashCode "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("len"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Entry")]),s._v(" e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n         e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n         e "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tab"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextIndex")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" len"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//将entry的key置为null")]),s._v("\n            e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("clear")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//将该entry的value也置为null")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("expungeStaleEntry")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("该方法逻辑很简单，通过往后环形查找到与指定key相同的entry后，先通过clear方法将key置为null后，使其转换为一个脏entry，然后调用expungeStaleEntry方法将其value置为null，以便垃圾回收时能够清理，同时将table[i]置为null。")]),s._v(" "),n("h2",{attrs:{id:"_4、threadlocal的使用场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4、threadlocal的使用场景"}},[s._v("#")]),s._v(" 4、ThreadLocal的使用场景")]),s._v(" "),n("p",[n("strong",[s._v("ThreadLocal 不是用来解决共享对象的多线程访问问题的")]),s._v("，数据实质上是放在每个thread实例引用的threadLocalMap，也就是说"),n("strong",[s._v("每个不同的线程都拥有专属于自己的数据容器（threadLocalMap），彼此不影响")]),s._v("。因此threadLocal只适用于 "),n("strong",[s._v("共享对象会造成线程安全")]),s._v(" 的业务场景。比如"),n("strong",[s._v("hibernate中通过threadLocal管理Session")]),s._v("就是一个典型的案例，不同的请求线程（用户）拥有自己的session，若将session共享出去被多线程访问，必然会带来线程安全问题。下面，我们自己来写一个例子，SimpleDateFormat.parse方法会有线程安全的问题，我们可以尝试使用threadLocal包装SimpleDateFormat，将该实例不被多线程共享即可。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocalDemo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SimpleDateFormat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" sdf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExecutorService")]),s._v(" executorService "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("newFixedThreadPool")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            executorService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("submit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DateUtil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-11-25 09:00:"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DateUtil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DateUtil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("date "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n        "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sdf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                sdf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SimpleDateFormat")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yyyy-MM-dd HH:mm:ss"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),s._v(" date "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sdf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("parse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ParseException")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("ol",[n("li",[s._v("如果当前线程不持有SimpleDateformat对象实例，那么就新建一个并把它设置到当前线程中，如果已经持有，就直接使用。另外，"),n("strong",[s._v("从"),n("code",[s._v("if (sdf.get() == null){....}else{.....}")]),s._v("可以看出为每一个线程分配一个SimpleDateformat对象实例是从应用层面（业务代码逻辑）去保证的。")])]),s._v(" "),n("li",[s._v("在上面我们说过threadLocal有可能存在内存泄漏，在使用完之后，最好使用remove方法将这个变量移除，就像在使用数据库连接一样，及时关闭连接。")])]),s._v(" "),n("h2",{attrs:{id:"_5、threadlocal最佳实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5、threadlocal最佳实践"}},[s._v("#")]),s._v(" 5、ThreadLocal最佳实践")]),s._v(" "),n("p",[s._v("上面说ThreadLocal有内存泄漏问题，对那么实践中我们应该怎么做？")]),s._v(" "),n("ol",[n("li",[s._v("每次使用完ThreadLocal，都调用它的remove()方法，清除数据。")]),s._v(" "),n("li",[s._v("在使用线程池的情况下，没有及时清理ThreadLocal，不仅是内存泄漏的问题，更严重的是可能导致业务逻辑出现问题。所以，使用ThreadLocal就跟加锁完要解锁一样，用完就清理。")])]),s._v(" "),n("blockquote",[n("p",[s._v("参考资料")])]),s._v(" "),n("p",[s._v("《java高并发程序设计》")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/CL0610/Java-concurrency/blob/master/17.%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BThreadLocal/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E4%B9%8BThreadLocal.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("并发容器之ThreadLocal"),n("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);